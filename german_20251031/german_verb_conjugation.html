<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾·è¯­åŠ¨è¯å˜ä½è€ƒæ ¸å™¨</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="german_common.css">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        /* é¡µé¢ç‰¹å®šæ ·å¼ */
        .nav-btn:hover {
            background: var(--foreground);
            color: var(--background);
            border-color: var(--foreground);
        }
        
        .option-btn,
        .func-btn {
            border-radius: 8px;
        }
        
        /* DWDSè¯å…¸é“¾æ¥æ ·å¼ */
        .dwds-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1.2rem;
            margin-top: 1rem;
            background: var(--surface-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--foreground);
            font-size: 0.9rem;
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            font-weight: 500;
        }
        
        .dwds-link:hover {
            background: var(--foreground);
            color: var(--surface);
            border-color: var(--foreground);
            transform: translateY(-1px);
        }
        
        .dwds-link i {
            font-size: 0.9rem;
        }
        
        /* é”®ç›˜å¿«æ·é”®æç¤º */
        .keyboard-hint {
            text-align: center;
            padding: 1rem;
            margin: 1.5rem 0;
            background: var(--surface-elevated);
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        .keyboard-hint kbd {
            display: inline-block;
            padding: 0.3rem 0.6rem;
            margin: 0 0.3rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--foreground);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* å†å²è®°å½•æ ·å¼ */
        .history-container {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 2rem 0;
            overflow: visible;
            position: relative;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .history-title {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .history-stats {
            font-size: 0.85rem;
            color: var(--text-muted);
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .stat-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.9rem;
            border-radius: 16px;
            border: 2px solid;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        /* å†å²ç½‘æ ¼ */
        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(24px, 1fr));
            gap: 4px;
            padding: 1rem 0;
            max-width: 100%;
            overflow: visible;
        }
        
        .history-box {
            width: 24px;
            height: 24px;
            border-radius: 3px;
            border: 1px solid var(--border);
            background: var(--surface);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .history-box.empty {
            background: #e0e0e0;
            border: 1px dashed var(--border);
            opacity: 0.6;
        }
        
        .history-box.correct {
            background: #4CAF50;
            border-color: #388E3C;
        }
        
        .history-box.slow {
            background: #FF9800;
            border-color: #F57C00;
        }
        
        .history-box.incorrect {
            background: #D32F2F;
            border-color: #B71C1C;
        }
        
        .history-box:hover {
            transform: scale(1.3);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }
        
        /* Tooltip */
        .history-tooltip {
            position: fixed;
            background: var(--foreground);
            color: var(--surface);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            display: none;
            transition: opacity 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            min-width: 200px;
            max-width: 300px;
        }
        
        .tooltip-time {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #FFD54F;
        }
        
        .tooltip-question {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .tooltip-answer {
            color: #81C784;
        }
        
        /* å®Œæˆå¼¹çª— */
        .completion-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .completion-modal.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .completion-content {
            background: var(--surface);
            border-radius: 16px;
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .completion-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .completion-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--foreground);
        }
        
        .completion-stats {
            background: var(--surface-elevated);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            text-align: left;
        }
        
        .completion-stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }
        
        .completion-stat-item:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            color: var(--foreground);
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .stat-value.green { color: #4CAF50; }
        .stat-value.orange { color: #FF9800; }
        .stat-value.red { color: #D32F2F; }
        
        .completion-message {
            font-size: 1rem;
            color: var(--text-muted);
            margin: 1.5rem 0;
            line-height: 1.6;
        }
        
        .completion-btn {
            background: var(--foreground);
            color: var(--surface);
            border: none;
            border-radius: 12px;
            padding: 1rem 3rem;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            margin-top: 1rem;
        }
        
        .completion-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        
        /* è¯„ä»·æŒ‰é’®ç»„ */
        .rating-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            padding: 1.5rem;
        }
        
        .rating-btn {
            flex: 1;
            max-width: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1.2rem 2rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--surface);
            color: var(--foreground);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }
        
        .rating-btn i {
            font-size: 1.5rem;
        }
        
        .rating-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .know-btn {
            border-color: #4CAF50;
            color: #4CAF50;
        }
        
        .know-btn:hover:not(:disabled) {
            background: #4CAF50;
            color: white;
        }
        
        .know-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background: var(--surface);
            color: var(--text-muted);
            border-color: var(--border);
        }
        
        .unfamiliar-btn {
            border-color: #D32F2F;
            color: #D32F2F;
        }
        
        .unfamiliar-btn:hover:not(:disabled) {
            background: #D32F2F;
            color: white;
        }
        
        .unfamiliar-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background: var(--surface);
            color: var(--text-muted);
            border-color: var(--border);
        }
        
        .next-btn {
            border-color: var(--border-dark);
            color: var(--foreground);
        }
        
        .next-btn:hover:not(:disabled) {
            background: var(--foreground);
            color: var(--surface);
        }
        
        .next-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background: var(--surface);
            color: var(--text-muted);
            border-color: var(--border);
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .rating-buttons {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .rating-btn {
                max-width: 100%;
                flex-direction: row;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
            <a href="german_index.html" class="nav-btn">â† è¿”å›ä¸»é¡µ</a>
            <h1>å¾·è¯­åŠ¨è¯å˜ä½è€ƒæ ¸å™¨</h1>
        <div class="subtitle">åŠ¨è¯é€‰æ‹© | æ—¶æ€é€‰æ‹© | äººç§°é€‰æ‹© | åŒå‘è€ƒæ ¸ | ååº”è®¡æ—¶</div>

        <!-- åŠ¨è¯ç±»å‹é€‰æ‹© -->
        <div class="option-group">
            <span class="option-label">é€‰æ‹©åŠ¨è¯ç±»å‹ï¼š</span>
            <div class="option-buttons">
                <button class="option-btn active" data-type="all">æ‰€æœ‰åŠ¨è¯</button>
                <button class="option-btn" data-type="regular">è§„åˆ™åŠ¨è¯</button>
                <button class="option-btn" data-type="irregular">ä¸è§„åˆ™åŠ¨è¯</button>
                <button class="option-btn" data-type="modal">æƒ…æ€åŠ¨è¯</button>
                <button class="option-btn" data-type="special">ç‰¹æ®ŠåŠ¨è¯</button>
            </div>
        </div>

        <!-- æ—¶æ€é€‰æ‹© -->
        <div class="option-group">
            <span class="option-label">é€‰æ‹©è€ƒæ ¸æ—¶æ€ï¼š</span>
            <div class="option-buttons">
                <button class="option-btn active" data-tense="present">ç°åœ¨æ—¶</button>
                <button class="option-btn" data-tense="past">è¿‡å»æ—¶</button>
                <button class="option-btn" data-tense="perfect">å®Œæˆæ—¶</button>
                <button class="option-btn" data-tense="all">æ‰€æœ‰æ—¶æ€</button>
            </div>
        </div>

        <!-- åŠŸèƒ½æŒ‰é’® -->
        <div class="func-buttons">
            <button class="func-btn" id="btn-start-test">å¼€å§‹ä¸€è½®æ–°è€ƒæ ¸</button>
        </div>

        <!-- å†…å®¹å¡ç‰‡ -->
        <div class="card">
            <div class="card-left" id="card-left">
                <div class="timer" id="timer">00:00.00</div>
                <div class="card-title" id="card-title">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹è€ƒæ ¸</div>
                <div class="card-instruction" id="card-instruction">å°†è¿›è¡Œä¸€è½®å®Œæ•´çš„åŠ¨è¯å˜ä½è€ƒæ ¸...</div>
                <div class="card-content" id="card-content">â€”â€”</div>
                <a href="#" id="dwds-link" class="dwds-link" target="_blank" style="display: none;">
                    <i class="fas fa-book-open"></i> DWDSè¯å…¸
                </a>
            </div>
            <div class="card-right" id="card-right">
                <div class="answer" id="answer" style="display: none;">
                    <span id="answer-text">ç­”æ¡ˆå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</span>
                    <div class="time-used" id="time-used"></div>
                </div>
                
                <!-- ç­”é¢˜æŒ‰é’®ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰ -->
                <div class="rating-buttons" id="rating-buttons">
                    <button class="rating-btn know-btn" id="know-btn" disabled>
                        <i class="fas fa-check-circle"></i>
                        <span>ç†Ÿæ‚‰</span>
                    </button>
                    <button class="rating-btn unfamiliar-btn" id="unfamiliar-btn" disabled>
                        <i class="fas fa-flag"></i>
                        <span>ä¸ç†Ÿæ‚‰</span>
                    </button>
                    <button class="rating-btn next-btn" id="next-btn" disabled>
                        <i class="fas fa-arrow-right"></i>
                        <span>ä¸‹ä¸€é¢˜</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="tip">
            ğŸ’¡ æç¤ºï¼šé€‰æ‹©é€‰é¡¹ â†’ å¼€å§‹è€ƒæ ¸ â†’ æ€è€ƒç­”æ¡ˆ â†’ ç‚¹å‡»"ç†Ÿæ‚‰"æˆ–"ä¸ç†Ÿæ‚‰"æŸ¥çœ‹ç­”æ¡ˆ â†’ ç‚¹å‡»"ä¸‹ä¸€é¢˜"ç»§ç»­ | åŒå‡»åŠ¨è¯å¯æœ—è¯»
        </div>
        
        <!-- é”®ç›˜å¿«æ·é”®æç¤º -->
        <div class="keyboard-hint">
            <kbd>ç©ºæ ¼</kbd> ç†Ÿæ‚‰/ä¸‹ä¸€é¢˜ | <kbd>D</kbd> æ‰“å¼€DWDSè¯å…¸ | åŒå‡»åŠ¨è¯æœ—è¯»
        </div>

        <!-- å†å²è®°å½• -->
        <div class="history-container">
            <div class="history-header">
                <div class="history-title">
                    <i class="fas fa-history"></i> ç­”é¢˜å†å²
                </div>
                <div class="history-stats" id="history-stats"></div>
                <button class="clear-history-btn" id="clear-history-btn">
                    <i class="fas fa-trash-alt"></i> æ¸…ç©º
                </button>
            </div>
            <div class="history-legend" style="display: flex; gap: 1.5rem; margin-bottom: 1rem; padding: 0.5rem 0; flex-wrap: wrap;">
                <span class="legend-item" style="display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--foreground); font-weight: 500;">
                    <span class="legend-box" style="width: 16px; height: 16px; border-radius: 2px; border: 1px solid #388E3C; background: #4CAF50; display: inline-block;"></span>
                    ç†Ÿæ‚‰
                </span>
                <span class="legend-item" style="display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--foreground); font-weight: 500;">
                    <span class="legend-box" style="width: 16px; height: 16px; border-radius: 2px; border: 1px solid #F57C00; background: #FF9800; display: inline-block;"></span>
                    æ…¢é€Ÿ
                </span>
                <span class="legend-item" style="display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--foreground); font-weight: 500;">
                    <span class="legend-box" style="width: 16px; height: 16px; border-radius: 2px; border: 1px solid #B71C1C; background: #D32F2F; display: inline-block;"></span>
                    ä¸ç†Ÿæ‚‰
                </span>
            </div>
            <div class="history-words" id="history-words">
                <div class="history-empty" style="text-align: center; padding: 3rem 1rem; color: var(--text-muted);">
                    <i class="fas fa-inbox" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                    <p>æš‚æ— ç»ƒä¹ è®°å½•</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å®Œæˆå¼¹çª— -->
    <div class="completion-modal" id="completion-modal">
        <div class="completion-content">
            <div class="completion-icon">ğŸ‰</div>
            <h2 class="completion-title">å®Œæˆä¸€è½®è€ƒæ ¸ï¼</h2>
            <div class="completion-stats" id="completion-stats-content"></div>
            <p class="completion-message" id="completion-message"></p>
            <button class="completion-btn" id="completion-btn">
                <i class="fas fa-redo"></i> å¼€å§‹æ–°ä¸€è½®
            </button>
        </div>
    </div>

    <script>
        // å†…åµŒCSVæ•°æ®ï¼ˆè§£å†³CORSé—®é¢˜ï¼‰
        const EMBEDDED_CSV_DATA = `infinitive,meaning,type,present_ich,present_du,present_er,present_wir,present_ihr,present_sie,past_ich,past_du,past_er,past_wir,past_ihr,past_sie,perfect_auxiliary,perfect_participle
arbeiten,å·¥ä½œ,regular,arbeite,arbeitest,arbeitet,arbeiten,arbeitet,arbeitet,arbeitete,arbeitetest,arbeitete,arbeiteten,arbeitetet,arbeiteten,habe,gearbeitet
lernen,å­¦ä¹ ,regular,lerne,lernst,lernt,lernen,lernt,lernen,lernte,lerntest,lernte,lernten,lerntet,lernten,habe,gelernt
fragen,è¯¢é—®,regular,frage,fragst,fragt,fragen,fragt,fragen,fragte,fragtest,fragte,fragten,fragtet,fragten,habe,gefragt
sagen,è¯´,regular,sage,sagst,sagt,sagen,sagt,sagen,sprach,sprachst,sprach,sprachen,spracht,sprachen,habe,gesagt
machen,åš,regular,mache,machst,macht,machen,macht,machen,machte,machtet,machte,machten,machtet,machten,habe,gemacht
spielen,ç©,regular,spiele,spielst,spielt,spielen,spielt,spielen,spielte,spieltet,spielte,spielten,spieltet,spielten,habe,gespielt
studieren,å­¦ä¹ ,regular,studiere,studierst,studiert,studieren,studiert,studieren,studierte,studiertet,studierte,studierten,studiertet,studierten,habe,studiert
wohnen,å±…ä½,regular,wohne,wohnst,wohnt,wohnen,wohnt,wohnen,wohnte,wohntest,wohnte,wohnten,wohntet,wohnten,habe,gewohnt
gehen,å»,irregular,gehe,gehst,geht,gehen,geht,gehen,ging,gingst,ging,gingen,gingt,gingen,bin,gegangen
sehen,çœ‹,irregular,sehe,siehst,sieht,sehen,seht,sehen,sah,sahst,sah,sahen,saht,sahen,habe,gesehen
essen,åƒ,irregular,esse,isst,isst,essen,esst,essen,aÃŸ,aÃŸt,aÃŸ,aÃŸen,aÃŸt,aÃŸen,habe,gegessen
kommen,æ¥,irregular,komme,kommst,kommt,kommen,kommt,kommen,kam,kamst,kam,kamen,kamt,kamen,bin,gekommen
singen,å”±æ­Œ,irregular,singe,singst,singt,singen,singt,singen,sang,sangst,sang,saÃŸen,sangt,saÃŸen,habe,gesungen
trinken,å–,irregular,trinke,trinkst,trinkt,trinken,trinkt,trinken,trank,trankst,trank,tranken,trankt,tranken,habe,getrunken
fahren,è¡Œé©¶,irregular,fahre,fÃ¤hrst,fÃ¤hrt,fahren,fahrt,fahren,fuhren,fuhrenst,fuhren,fuhren,fuhret,fuhren,bin,gefahren
kennen,è®¤è¯†,irregular,kenne,kennst,kennen,kennen,kennt,kennen,kannte,kantest,kannte,kanten,kantet,kanten,habe,gekannt
kÃ¶nnen,èƒ½å¤Ÿ,modal,kann,kannst,kann,kÃ¶nnen,kÃ¶nnt,kÃ¶nnen,konnte,konntest,konnte,konnten,konntet,konnten,haben,gekonnt
mÃ¼ssen,å¿…é¡»,modal,muss,musst,muss,mÃ¼ssen,mÃ¼sst,mÃ¼ssen,musste,musstest,musste,mussten,musstet,mussten,haben,gemusst
sollen,åº”è¯¥,modal,soll,sollst,soll,sollen,sollt,sollen,sollte,solltet,sollte,sollten,solltet,sollten,haben,gesollt
wollen,æƒ³è¦,modal,will,willst,will,wollen,wollt,wollen,wollte,wolltet,wollte,wollten,wolltet,wollten,haben,gewollt
mÃ¶gen,å–œæ¬¢,modal,mÃ¶chte,mÃ¶chtest,mÃ¶chte,mÃ¶chten,mÃ¶chtet,mÃ¶chten,mochte,mochtest,mochte,mochten,mochtet,mochten,haben,gemocht
sein,æ˜¯,special,bin,bist,ist,sind,seid,sind,war,warst,war,waren,wart,waren,bin,gewesen
haben,æœ‰,special,habe,hast,hat,haben,habt,haben,hatte,hattest,hatte,hatten,hattet,hatten,habe,gehabt
lesen,è¯»,regular,lese,liest,liest,lesen,lest,lesen,las,lasst,las,lasen,last,lasen,habe,gelesen
schreiben,å†™,regular,schreibe,schreibst,schreibt,schreiben,schreibt,schreiben,schrieb,schriebst,schrieb,schrieben,schrieft,schrieben,habe,geschrieben
tun,åš,irregular,tue,tust,tut,tun,tut,tun,tat,tust,tut,tun,tut,tun,habe,getan
tragen,æºå¸¦,regular,trage,trÃ¤gst,trÃ¤gt,tragen,tragt,tragen,trug,trugst,trug,trugen,trugt,trugen,habe,getragen
finden,æ‰¾åˆ°,irregular,finde,findest,findet,finden,finde,finden,fand,fandest,fand,fanden,fanet,fanden,habe,gefunden
bleiben,åœç•™,irregular,bleibe,bleibst,bleibt,bleiben,bleibt,bleiben,blieb,bliebst,blieb,blieben,bliebet,blieben,bin,geblieben
bauen,å»ºé€ ,regular,baue,baust,baut,bauen,baut,bauen,bauten,bautest,bauten,bauten,bautet,bauten,habe,gebaut
helfen,å¸®åŠ©,regular,helfe,hilfst,hilft,helfen,helft,helfen,half,halfst,half,halfen,halft,halfen,habe,geholfen
hÃ¶ren,å¬,regular,hÃ¶re,hÃ¶rst,hÃ¶rt,hÃ¶ren,hÃ¶rt,hÃ¶ren,hÃ¶rte,hÃ¶rtest,hÃ¶rte,hÃ¶rten,hÃ¶rtet,hÃ¶rten,habe,gehÃ¶rt
nehmen,æ‹¿,irregular,nehme,nimmst,nimmt,nehmen,nehmt,nehmen,nahm,nahmst,nahm,nahmen,nahmt,nahmen,habe,genommen
stehen,ç«™,irregular,stehe,stehst,steht,stehen,steht,stehen,stand,standest,stand,standen,standet,standen,habe,gestanden
kaufen,ä¹°,regular,kaufe,kaufst,kauft,kaufen,kauft,kaufen,kaufte,kauftest,kaufte,kauften,kauftet,kauften,habe,gekauft
bringen,å¸¦æ¥,irregular,bringe,bringst,bringt,bringen,bringt,bringen,brachte,brachtest,brachte,brachten,brachtet,brachten,habe,gebracht
wissen,çŸ¥é“,irregular,weiÃŸ,weiÃŸt,weiÃŸ,wissen,wisst,wissen,wusste,wusstest,wusste,wussten,wusstet,wussten,habe,gewusst
werden,æˆä¸º,irregular,werde,wirst,wird,werden,werdet,werden,ward,wurdest,ward,warden,wurdet,warden,bin,geworden
geben,ç»™,irregular,gebe,gibst,gibt,geben,gebt,geben,gab,gabst,gab,gaben,gabt,gaben,habe,gegeben
anrufen,æ‰“ç”µè¯,regular,rufe an,rufst an,ruft an,rufen an,ruft an,rufen an,rief an,riefst an,rief an,riefen an,riefet an,riefen an,habe,angerufen
antworten,å›ç­”,regular,antworte,antwortest,antwortet,antworten,antwortet,antworten,antwortete,antwortetest,antwortete,antworteten,antwortetet,antworteten,habe,geantwortet
verstehen,ç†è§£,irregular,verstehe,verstehst,versteht,verstehen,versteht,verstehen,verstand,verstandest,verstand,verstanden,verstandet,verstanden,habe,verstanden`;

        // æ ¸å¿ƒå˜é‡
        let currentVerbType = "all";
        let currentTense = "present";
        let timerInterval = null;
        let startTime = 0;
        let currentAnswer = "";
        let currentQuestion = {};
        let verbsData = [];
        let isLoading = false;
        let isAnswered = false;
        let testInProgress = false;
        let currentTestQuestions = [];
        let currentQuestionIndex = 0;
        let currentRoundAnswers = [];
        let completedRoundSnapshot = null;
        const SUPPORTED_VOICES = [];

        // DOMå…ƒç´ 
        const btnStartTest = document.getElementById('btn-start-test');
        const typeBtns = document.querySelectorAll('.option-btn[data-type]');
        const tenseBtns = document.querySelectorAll('.option-btn[data-tense]');
        const cardLeft = document.getElementById('card-left');
        const cardRight = document.getElementById('card-right');
        const cardTitle = document.getElementById('card-title');
        const cardInstruction = document.getElementById('card-instruction');
        const cardContent = document.getElementById('card-content');
        const answer = document.getElementById('answer');
        const answerText = document.getElementById('answer-text');
        const timeUsed = document.getElementById('time-used');
        const timer = document.getElementById('timer');
        const dwdsLink = document.getElementById('dwds-link');
        const historyWordsContainer = document.getElementById('history-words');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const completionModal = document.getElementById('completion-modal');
        const completionBtn = document.getElementById('completion-btn');
        const completionStatsContent = document.getElementById('completion-stats-content');
        const completionMessage = document.getElementById('completion-message');
        const knowBtn = document.getElementById('know-btn');
        const unfamiliarBtn = document.getElementById('unfamiliar-btn');
        const nextBtn = document.getElementById('next-btn');
        const ratingButtons = document.getElementById('rating-buttons');

        // é¡µé¢åŠ è½½
        window.addEventListener('load', async () => {
            try {
                loadVerbsData();
                isLoading = false;
                cardTitle.textContent = "æ•°æ®åŠ è½½å®Œæˆï¼Œè¯·é€‰æ‹©é€‰é¡¹å¹¶å¼€å§‹è€ƒæ ¸";
                
                loadVoices();
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.onvoiceschanged = loadVoices;
                }
            } catch (error) {
                console.error("åŠ è½½åŠ¨è¯æ•°æ®å¤±è´¥:", error);
                cardTitle.textContent = "æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•";
            }
        });

        // åŠ è½½åŠ¨è¯æ•°æ®ï¼ˆå†…åµŒCSVï¼‰
        function loadVerbsData() {
            Papa.parse(EMBEDDED_CSV_DATA, {
                        header: true,
                skipEmptyLines: true,
                        complete: function(results) {
                            verbsData = results.data.map(row => {
                                return {
                                    infinitive: row.infinitive,
                                    meaning: row.meaning,
                                    type: row.type,
                                    conjugations: {
                                        present: {
                                            ich: row.present_ich,
                                            du: row.present_du,
                                            er: row.present_er,
                                            wir: row.present_wir,
                                            ihr: row.present_ihr,
                                            sie: row.present_sie
                                        },
                                        past: {
                                            ich: row.past_ich,
                                            du: row.past_du,
                                            er: row.past_er,
                                            wir: row.past_wir,
                                            ihr: row.past_ihr,
                                            sie: row.past_sie
                                        },
                                        perfect: {
                                            auxiliary: row.perfect_auxiliary,
                                            participle: row.perfect_participle
                                        }
                                    }
                                };
                            });
                    console.log('å·²åŠ è½½', verbsData.length, 'ä¸ªåŠ¨è¯');
                        },
                        error: function(error) {
                    console.error("è§£æCSVå¤±è´¥:", error);
                }
            });
        }

        // åŠ¨è¯ç±»å‹åˆ‡æ¢
        typeBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                if (testInProgress) return;
                typeBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentVerbType = this.dataset.type;
                cardTitle.textContent = `å·²é€‰æ‹©${this.textContent}ï¼Œè¯·é€‰æ‹©æ—¶æ€å¹¶å¼€å§‹`;
            });
        });

        // æ—¶æ€åˆ‡æ¢
        tenseBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                if (testInProgress) return;
                tenseBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentTense = this.dataset.tense;
                cardTitle.textContent = `å·²é€‰æ‹©${this.textContent}ï¼Œè¯·å¼€å§‹è€ƒæ ¸`;
            });
        });

        // å¼€å§‹è€ƒæ ¸
        btnStartTest.addEventListener('click', function() {
            if (isLoading || testInProgress) return;
            startNewTest();
        });

        // å¼€å§‹æ–°è€ƒæ ¸
        function startNewTest() {
            // è¿‡æ»¤åŠ¨è¯
            let filteredVerbs = verbsData;
            if (currentVerbType !== "all") {
                filteredVerbs = filteredVerbs.filter(verb => verb.type === currentVerbType);
            }
            
            if (filteredVerbs.length === 0) {
                alert("æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„åŠ¨è¯");
                return;
            }
            
            // æ‰“ä¹±é¡ºåº
            currentTestQuestions = shuffleArray([...filteredVerbs]);
            currentQuestionIndex = 0;
            currentRoundAnswers = [];
            testInProgress = true;
            
            // ç¦ç”¨é€‰é¡¹æŒ‰é’®
            typeBtns.forEach(btn => btn.disabled = true);
            tenseBtns.forEach(btn => btn.disabled = true);
            btnStartTest.disabled = true;
            
            // æ˜¾ç¤ºç¬¬ä¸€é¢˜
            showNextQuestion();
        }

        // æ˜¾ç¤ºä¸‹ä¸€é¢˜
        function showNextQuestion() {
            if (currentQuestionIndex >= currentTestQuestions.length) {
                // å®Œæˆæœ¬è½®
                completeTest();
                return;
            }
            
            resetCard();
            isAnswered = false;
            
            const verb = currentTestQuestions[currentQuestionIndex];
            
            // éšæœºé€‰æ‹©æ—¶æ€
            let tenses = ["present", "past", "perfect"];
            if (currentTense !== "all") {
                tenses = [currentTense];
            }
            const randomTense = tenses[Math.floor(Math.random() * tenses.length)];
            
            // éšæœºé€‰æ‹©äººç§°æˆ–å®Œæˆæ—¶å½¢å¼
            let person, questionText, answerTextValue;
            const persons = ["ich", "du", "er", "wir", "ihr", "sie"];
            
            if (randomTense === "perfect") {
                const askAuxiliary = Math.random() > 0.5;
                person = "perfect";
                if (askAuxiliary) {
                    questionText = `${verb.infinitive} (${verb.meaning}) çš„å®Œæˆæ—¶åŠ©åŠ¨è¯æ˜¯ï¼Ÿ`;
                    answerTextValue = verb.conjugations.perfect.auxiliary;
                } else {
                    questionText = `${verb.infinitive} (${verb.meaning}) çš„å®Œæˆæ—¶åˆ†è¯æ˜¯ï¼Ÿ`;
                    answerTextValue = verb.conjugations.perfect.participle;
                }
            } else {
                person = persons[Math.floor(Math.random() * persons.length)];
                const personText = getPersonText(person);
                const tenseText = getTenseText(randomTense);
                questionText = `${verb.infinitive} (${verb.meaning}) ${tenseText} ${personText} çš„å˜ä½æ˜¯ï¼Ÿ`;
                answerTextValue = verb.conjugations[randomTense][person];
            }
            
            // ä¿å­˜å½“å‰é—®é¢˜
            currentQuestion = {
                verb: verb.infinitive,
                meaning: verb.meaning,
                type: verb.type,
                tense: randomTense,
                person: person,
                questionText: questionText
            };
            currentAnswer = answerTextValue;
            
            // æ›´æ–°UI
            cardTitle.textContent = `ç¬¬ ${currentQuestionIndex + 1} / ${currentTestQuestions.length} é¢˜`;
            cardInstruction.textContent = questionText;
            cardContent.textContent = verb.infinitive;
            updateDWDSLink(verb.infinitive);
            
            // éšè—ç­”æ¡ˆï¼Œå¯ç”¨ç†Ÿæ‚‰/ä¸ç†Ÿæ‚‰æŒ‰é’®ï¼Œç¦ç”¨ä¸‹ä¸€é¢˜æŒ‰é’®
            answer.style.display = "none";
            if (knowBtn) knowBtn.disabled = false;
            if (unfamiliarBtn) unfamiliarBtn.disabled = false;
            if (nextBtn) nextBtn.disabled = true;
            
            // è‡ªåŠ¨æœ—è¯»åŠ¨è¯
            speakText(verb.infinitive, 'de-DE');
            
            // å¼€å§‹è®¡æ—¶
            startTimer();
        }

        // ç†Ÿæ‚‰æŒ‰é’®
        if (knowBtn) {
            knowBtn.addEventListener('click', function() {
                if (!isAnswered) {
                    showAnswer(false); // false = ç†Ÿæ‚‰
                }
            });
        }

        // ä¸ç†Ÿæ‚‰æŒ‰é’®
        if (unfamiliarBtn) {
            unfamiliarBtn.addEventListener('click', function() {
                if (!isAnswered) {
                    showAnswer(true); // true = ä¸ç†Ÿæ‚‰
                }
            });
        }

        // ä¸‹ä¸€é¢˜æŒ‰é’®
        if (nextBtn) {
            nextBtn.addEventListener('click', function() {
                if (!nextBtn.disabled) {
                    currentQuestionIndex++;
                    showNextQuestion();
                }
            });
        }

        // æ˜¾ç¤ºç­”æ¡ˆ
        function showAnswer(isUnfamiliar) {
            if (isAnswered) return;
            
            // åœæ­¢è®¡æ—¶
            stopTimer();
            const elapsed = startTime ? Math.floor((Date.now() - startTime) / 1000) : 0;
            
            // æ˜¾ç¤ºç­”æ¡ˆ
            answerText.textContent = currentAnswer;
            timeUsed.textContent = `ååº”æ—¶é—´ï¼š${elapsed} ç§’`;
            answer.style.display = "block";
            timer.style.color = "var(--success)";
            isAnswered = true;
            
            // ç¦ç”¨ç†Ÿæ‚‰/ä¸ç†Ÿæ‚‰æŒ‰é’®ï¼Œå¯ç”¨ä¸‹ä¸€é¢˜æŒ‰é’®
            if (knowBtn) knowBtn.disabled = true;
            if (unfamiliarBtn) unfamiliarBtn.disabled = true;
            if (nextBtn) nextBtn.disabled = false;
            
            // è®°å½•ç­”æ¡ˆ
            currentRoundAnswers[currentQuestionIndex] = {
                verb: currentQuestion.verb,
                meaning: currentQuestion.meaning,
                tense: getTenseText(currentQuestion.tense),
                person: currentQuestion.person !== 'perfect' ? getPersonText(currentQuestion.person) : 'å®Œæˆæ—¶',
                question: currentQuestion.questionText,
                answer: currentAnswer,
                time: elapsed,
                unfamiliar: isUnfamiliar // è®°å½•æ˜¯å¦ä¸ç†Ÿæ‚‰
            };
            
            // æ›´æ–°å†å²æ˜¾ç¤º
            updateHistoryDisplay();
        }

        // å®Œæˆè€ƒæ ¸
        function completeTest() {
            testInProgress = false;
            completedRoundSnapshot = JSON.parse(JSON.stringify(currentRoundAnswers));
            
            // å¯ç”¨é€‰é¡¹æŒ‰é’®
            typeBtns.forEach(btn => btn.disabled = false);
            tenseBtns.forEach(btn => btn.disabled = false);
            btnStartTest.disabled = false;
            
            // é‡ç½®å¡ç‰‡
            resetCard();
            cardTitle.textContent = "æœ¬è½®è€ƒæ ¸å·²å®Œæˆï¼";
            cardInstruction.textContent = "å¯æŸ¥çœ‹ç­”é¢˜å†å²ï¼Œæˆ–å¼€å§‹æ–°ä¸€è½®è€ƒæ ¸";
            
            // æ˜¾ç¤ºå®Œæˆå¼¹çª—
            setTimeout(() => showCompletionModal(), 500);
        }

        // æ˜¾ç¤ºå®Œæˆå¼¹çª—
        function showCompletionModal() {
            if (!completionModal || !completedRoundSnapshot) return;
            
            const roundData = completedRoundSnapshot;
            const times = roundData.map(item => item.time);
            const mean = times.reduce((sum, t) => sum + t, 0) / times.length;
            const variance = times.reduce((sum, t) => sum + Math.pow(t - mean, 2), 0) / times.length;
            const threshold = mean + Math.sqrt(variance);
            
            // åˆ†ç±»ç»Ÿè®¡
            const unfamiliarCount = roundData.filter(item => item.unfamiliar).length;
            const familiarCount = roundData.filter(item => !item.unfamiliar).length;
            const slowCount = roundData.filter(item => !item.unfamiliar && item.time > threshold && roundData.length > 3).length;
            const fastCount = familiarCount - slowCount;
            const accuracy = ((familiarCount / roundData.length) * 100).toFixed(1);
            
            // ç»Ÿè®¡ä¿¡æ¯
            completionStatsContent.innerHTML = `
                <div class="completion-stat-item">
                    <span class="stat-label">
                        <i class="fas fa-check-circle" style="color: #4CAF50;"></i>
                        ç†Ÿæ‚‰
                    </span>
                    <span class="stat-value green">${fastCount}</span>
                </div>
                ${slowCount > 0 ? `
                <div class="completion-stat-item">
                    <span class="stat-label">
                        <i class="fas fa-clock" style="color: #FF9800;"></i>
                        æ…¢é€Ÿç†Ÿæ‚‰
                    </span>
                    <span class="stat-value orange">${slowCount}</span>
                </div>
                ` : ''}
                ${unfamiliarCount > 0 ? `
                <div class="completion-stat-item">
                    <span class="stat-label">
                        <i class="fas fa-times-circle" style="color: #D32F2F;"></i>
                        ä¸ç†Ÿæ‚‰
                    </span>
                    <span class="stat-value red">${unfamiliarCount}</span>
                </div>
                ` : ''}
                <div class="completion-stat-item">
                    <span class="stat-label">
                        <i class="fas fa-chart-line"></i>
                        æŒæ¡ç‡
                    </span>
                    <span class="stat-value" style="color: ${accuracy >= 80 ? '#4CAF50' : accuracy >= 60 ? '#FF9800' : '#D32F2F'};">
                        ${accuracy}%
                    </span>
                </div>
            `;
            
            // é¼“åŠ±ä¿¡æ¯
            let message = '';
            if (accuracy >= 90) {
                message = 'ğŸŒŸ å¤ªæ£’äº†ï¼æ‚¨å·²ç»æŒæ¡å¾—éå¸¸å¥½äº†ï¼';
            } else if (accuracy >= 75) {
                message = 'ğŸ‘ ä¸é”™ï¼ç»§ç»­ä¿æŒï¼Œæ‚¨åšå¾—å¾ˆå¥½ï¼';
            } else if (accuracy >= 60) {
                message = 'ğŸ’ª åŠ æ²¹ï¼å¤šç»ƒå‡ è½®å°±èƒ½å®Œå…¨æŒæ¡äº†ï¼';
            } else {
                message = 'ğŸ“š ä¸è¦æ°”é¦ï¼Œç†Ÿèƒ½ç”Ÿå·§ï¼è®©æˆ‘ä»¬å†ç»ƒä¸€è½®å§ï¼';
            }
            
            if (unfamiliarCount > 0) {
                message += `\né‡ç‚¹å¤ä¹ æ ‡è®°ä¸ºä¸ç†Ÿæ‚‰çš„ ${unfamiliarCount} ä¸ªåŠ¨è¯ã€‚`;
            }
            
            completionMessage.textContent = message;
            
            completionModal.classList.add('show');
        }

        // å…³é—­å¼¹çª—å¹¶å¼€å§‹æ–°ä¸€è½®
        completionBtn.addEventListener('click', function() {
            completionModal.classList.remove('show');
            completedRoundSnapshot = null;
        });

        // æ›´æ–°å†å²æ˜¾ç¤º
        function updateHistoryDisplay() {
            if (!historyWordsContainer || currentRoundAnswers.length === 0) return;
            
            // æ¸…ç†æ—§tooltip
            document.querySelectorAll('.history-tooltip').forEach(t => t.remove());
            
            historyWordsContainer.innerHTML = '';
            
            // è®¡ç®—ç»Ÿè®¡
            const times = currentRoundAnswers.map(item => item.time);
            const mean = times.reduce((sum, t) => sum + t, 0) / times.length;
            const variance = times.reduce((sum, t) => sum + Math.pow(t - mean, 2), 0) / times.length;
            const threshold = mean + Math.sqrt(variance);
            
            // åˆ†ç±»ç»Ÿè®¡
            const unfamiliarCount = currentRoundAnswers.filter(item => item.unfamiliar).length;
            const familiarCount = currentRoundAnswers.filter(item => !item.unfamiliar).length;
            const slowCount = currentRoundAnswers.filter(item => !item.unfamiliar && item.time > threshold).length;
            const fastCount = familiarCount - slowCount;
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            const historyStats = document.getElementById('history-stats');
            if (historyStats) {
                historyStats.innerHTML = `
                    <span class="stat-badge" style="background: #E8F5E9; border-color: #4CAF50; color: #2E7D32;">
                        <i class="fas fa-check-circle"></i> ç†Ÿæ‚‰: ${fastCount}
                    </span>
                    ${slowCount > 0 ? `
                    <span class="stat-badge" style="background: #FFF3E0; border-color: #FF9800; color: #E65100;">
                        <i class="fas fa-clock"></i> æ…¢é€Ÿ: ${slowCount}
                    </span>
                    ` : ''}
                    ${unfamiliarCount > 0 ? `
                    <span class="stat-badge" style="background: #FFEBEE; border-color: #D32F2F; color: #B71C1C;">
                        <i class="fas fa-times-circle"></i> ä¸ç†Ÿæ‚‰: ${unfamiliarCount}
                    </span>
                    ` : ''}
                `;
            }
            
            // åˆ›å»ºæ–¹å—ç½‘æ ¼
            const gridDiv = document.createElement('div');
            gridDiv.className = 'history-grid';
            
            for (let i = 0; i < currentRoundAnswers.length; i++) {
                const box = document.createElement('div');
                box.className = 'history-box';
                
                const item = currentRoundAnswers[i];
                
                if (item) {
                    // ç¡®å®šé¢œè‰²åˆ†ç±»
                    if (item.unfamiliar) {
                        box.classList.add('incorrect'); // ä¸ç†Ÿæ‚‰ - çº¢è‰²
                    } else if (currentRoundAnswers.length > 3 && item.time > threshold) {
                        box.classList.add('slow'); // æ…¢é€Ÿç†Ÿæ‚‰ - æ©™è‰²
                    } else {
                        box.classList.add('correct'); // ç†Ÿæ‚‰ - ç»¿è‰²
                    }
                    
                    // Tooltip
                    const tooltip = document.createElement('div');
                    tooltip.className = 'history-tooltip';
                    tooltip.innerHTML = `
                        <div class="tooltip-time">â±ï¸ ${item.time}s</div>
                        <div class="tooltip-question">ğŸ“ ${item.question}</div>
                        <div class="tooltip-answer">âœ“ ${item.answer}</div>
                    `;
                    document.body.appendChild(tooltip);
                    
                    // æ˜¾ç¤ºtooltipçš„å‡½æ•°
                    const showTooltipFunc = function() {
                        // å…ˆéšè—å…¶ä»–tooltip
                        document.querySelectorAll('.history-tooltip').forEach(t => {
                            if (t !== tooltip) {
                                t.style.opacity = '0';
                                t.style.display = 'none';
                            }
                        });
                        
                        const rect = box.getBoundingClientRect();
                        tooltip.style.display = 'block';
                        tooltip.style.opacity = '0';
                        const tooltipRect = tooltip.getBoundingClientRect();
                        
                        const spaceAbove = rect.top;
                        const spaceBelow = window.innerHeight - rect.bottom;
                        
                        if (spaceAbove > tooltipRect.height + 10 && spaceBelow < tooltipRect.height + 10) {
                            tooltip.style.top = (rect.top + window.scrollY - tooltipRect.height - 8) + 'px';
                        } else {
                            tooltip.style.top = (rect.bottom + window.scrollY + 8) + 'px';
                        }
                        
                        let left = rect.left + window.scrollX + rect.width / 2 - tooltipRect.width / 2;
                        if (left < 10) left = 10;
                        if (left + tooltipRect.width > window.innerWidth - 10) {
                            left = window.innerWidth - tooltipRect.width - 10;
                        }
                        tooltip.style.left = left + 'px';
                        tooltip.style.opacity = '1';
                    };
                    
                    const hideTooltipFunc = function() {
                        tooltip.style.opacity = '0';
                        setTimeout(() => tooltip.style.display = 'none', 200);
                    };
                    
                    // æ¡Œé¢ç«¯ï¼šé¼ æ ‡æ‚¬åœæ˜¾ç¤ºtooltip
                    box.addEventListener('mouseenter', showTooltipFunc);
                    box.addEventListener('mouseleave', hideTooltipFunc);
                    
                    // ç‚¹å‡»äº‹ä»¶ï¼šè§¦æ‘¸è®¾å¤‡å’Œé¼ æ ‡è®¾å¤‡åˆ†åˆ«å¤„ç†
                    let tooltipVisibleState = false;
                    let lastClickTime = 0;
                    
                    box.addEventListener('click', function(e) {
                        e.stopPropagation();
                        
                        const currentTime = Date.now();
                        const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
                        
                        if (isTouchDevice) {
                            // ç§»åŠ¨ç«¯ï¼šç¬¬ä¸€æ¬¡ç‚¹å‡»æ˜¾ç¤ºtooltipï¼Œç¬¬äºŒæ¬¡ç‚¹å‡»æœ—è¯»
                            if (!tooltipVisibleState || (currentTime - lastClickTime > 3000)) {
                                // æ˜¾ç¤ºtooltip
                                showTooltipFunc();
                                tooltipVisibleState = true;
                                lastClickTime = currentTime;
                            } else {
                                // æœ—è¯»å¹¶éšè—
                                speakText(item.verb, 'de-DE');
                                hideTooltipFunc();
                                tooltipVisibleState = false;
                            }
                        } else {
                            // æ¡Œé¢ç«¯ï¼šç›´æ¥æœ—è¯»
                            speakText(item.verb, 'de-DE');
                        }
                    });
                    
                    // è§¦æ‘¸å¼€å§‹äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
                    box.addEventListener('touchstart', function(e) {
                        e.stopPropagation();
                    });
                } else {
                    box.classList.add('empty');
                }
                
                gridDiv.appendChild(box);
            }
            
            historyWordsContainer.appendChild(gridDiv);
        }

        // æ¸…ç©ºå†å²
        clearHistoryBtn.addEventListener('click', function() {
            if (testInProgress) {
                alert('è€ƒæ ¸è¿›è¡Œä¸­ï¼Œæ— æ³•æ¸…ç©ºå†å²');
                return;
            }
            if (currentRoundAnswers.length === 0) return;
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå†å²è®°å½•å—ï¼Ÿ')) {
                currentRoundAnswers = [];
                updateHistoryDisplay();
                historyWordsContainer.innerHTML = `
                    <div class="history-empty" style="text-align: center; padding: 3rem 1rem; color: var(--text-muted);">
                        <i class="fas fa-inbox" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                        <p>æš‚æ— ç»ƒä¹ è®°å½•</p>
                    </div>
                `;
            }
        });

        // è¾…åŠ©å‡½æ•°
        function getPersonText(person) {
            const personMap = {
                ich: "ich (æˆ‘)",
                du: "du (ä½ )",
                er: "er/sie/es (ä»–/å¥¹/å®ƒ)",
                wir: "wir (æˆ‘ä»¬)",
                ihr: "ihr (ä½ ä»¬)",
                sie: "sie/Sie (ä»–ä»¬/æ‚¨)"
            };
            return personMap[person] || person;
        }

        function getTenseText(tense) {
            const tenseMap = {
                present: "ç°åœ¨æ—¶",
                past: "è¿‡å»æ—¶",
                perfect: "å®Œæˆæ—¶"
            };
            return tenseMap[tense] || tense;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startTimer() {
            startTime = Date.now();
            timer.style.display = "inline-block";
            timer.style.color = "var(--foreground)";
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const min = Math.floor(elapsed / 60000).toString().padStart(2, '0');
                const sec = Math.floor((elapsed % 60000) / 1000).toString().padStart(2, '0');
                const ms = Math.floor((elapsed % 1000) / 10).toString().padStart(2, '0');
                timer.textContent = `${min}:${sec}.${ms}`;
            }, 10);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function resetCard() {
            stopTimer();
            timer.textContent = "00:00.00";
            timer.style.display = "none";
            cardContent.textContent = "â€”â€”";
            answer.style.display = "none";
            if (dwdsLink) dwdsLink.style.display = "none";
            currentAnswer = "";
            currentQuestion = {};
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            if (knowBtn) knowBtn.disabled = true;
            if (unfamiliarBtn) unfamiliarBtn.disabled = true;
            if (nextBtn) nextBtn.disabled = true;
        }

        function updateDWDSLink(verb) {
            if (!verb || !dwdsLink) return;
            const cleanVerb = verb.trim();
            const dwdsUrl = `https://www.dwds.de/wb/${encodeURIComponent(cleanVerb)}`;
            dwdsLink.href = dwdsUrl;
            dwdsLink.style.display = 'inline-flex';
        }

        function speakText(text, language = 'de-DE') {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = language;
                utterance.rate = 0.9;
                if (SUPPORTED_VOICES.length > 0) {
                    const germanVoice = SUPPORTED_VOICES.find(voice => 
                        voice.lang === 'de-DE' || voice.lang.startsWith('de-')
                    );
                    if (germanVoice) utterance.voice = germanVoice;
                }
                window.speechSynthesis.speak(utterance);
            }
        }

        function loadVoices() {
            if ('speechSynthesis' in window) {
                const voices = window.speechSynthesis.getVoices();
                SUPPORTED_VOICES.length = 0;
                SUPPORTED_VOICES.push(...voices);
            }
        }

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space') {
                e.preventDefault();
                if (testInProgress) {
                    if (!isAnswered && knowBtn && !knowBtn.disabled) {
                        // æœªå›ç­”æ—¶ï¼Œç©ºæ ¼é”®é»˜è®¤é€‰æ‹©"ç†Ÿæ‚‰"
                        knowBtn.click();
                    } else if (isAnswered && nextBtn && !nextBtn.disabled) {
                        // å·²å›ç­”æ—¶ï¼Œç©ºæ ¼é”®ç‚¹å‡»"ä¸‹ä¸€é¢˜"
                        nextBtn.click();
                    }
                }
            } else if (e.code === 'KeyD' && dwdsLink && dwdsLink.style.display !== 'none') {
                e.preventDefault();
                dwdsLink.click();
            }
        });

        // åŒå‡»æœ—è¯»
        if (cardContent) {
            cardContent.addEventListener('dblclick', function() {
                const text = cardContent.textContent.trim();
                if (text && text !== 'â€”â€”') speakText(text, 'de-DE');
            });
        }

        if (answerText) {
            answerText.addEventListener('dblclick', function() {
                const text = answerText.textContent.trim();
                if (text && text !== 'ç­”æ¡ˆå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ') speakText(text, 'de-DE');
            });
        }
        
        // å…¨å±€ç‚¹å‡»äº‹ä»¶ï¼šç‚¹å‡»ç©ºç™½å¤„éšè—æ‰€æœ‰tooltipï¼ˆç§»åŠ¨ç«¯å‹å¥½ï¼‰
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.history-box')) {
                document.querySelectorAll('.history-tooltip').forEach(tooltip => {
                    tooltip.style.opacity = '0';
                    setTimeout(() => tooltip.style.display = 'none', 200);
                });
            }
        });
    </script>
</body>
</html>
