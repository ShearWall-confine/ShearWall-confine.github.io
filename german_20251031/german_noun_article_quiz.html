<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾·è¯­åè¯åŠå† è¯è€ƒæ ¸å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="german_common.css">
    <style>
        /* å…¨æ–°çš„å­¦ä¹ å¡ç‰‡è®¾è®¡ */
        .study-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 3rem;
            margin: 2rem 0;
            min-height: 300px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            position: relative;
        }
        
        .study-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            border-color: var(--border-dark);
        }
        
        .study-card.has-question {
            cursor: default;
        }
        
        /* é—®é¢˜æ˜¾ç¤ºåŒºåŸŸ */
        .card-question-area {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .question-text {
            font-size: 3rem;
            font-weight: 700;
            color: var(--foreground);
            letter-spacing: 0.02em;
            margin-bottom: 1.5rem;
            line-height: 1.2;
            user-select: none;
        }
        
        /* DWDSé“¾æ¥ */
        .dwds-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1.2rem;
            background: var(--surface-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--foreground);
            font-size: 0.9rem;
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            font-weight: 500;
        }
        
        .dwds-link:hover {
            background: var(--foreground);
            color: var(--surface);
            border-color: var(--foreground);
            transform: translateY(-1px);
        }
        
        .dwds-link i {
            font-size: 0.9rem;
        }
        
        /* ç­”æ¡ˆæ˜¾ç¤ºåŒºåŸŸ */
        .card-answer-area {
            text-align: center;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .answer-divider {
            width: 60px;
            height: 3px;
            background: linear-gradient(to right, transparent, var(--border-dark), transparent);
            margin: 2rem auto 1.5rem;
        }
        
        .answer-content {
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--success);
            margin-bottom: 2rem;
            line-height: 1.3;
        }
        
        /* ä¸»æ“ä½œæŒ‰é’® */
        .card-actions {
            text-align: center;
            margin-top: 2rem;
        }
        
        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 2.5rem;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }
        
        .primary-btn {
            background: var(--foreground);
            color: var(--surface);
        }
        
        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .primary-btn:active {
            transform: translateY(0);
        }
        
        /* è¯„ä»·æŒ‰é’®ç»„ */
        .rating-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .rating-btn {
            flex: 1;
            max-width: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1.2rem 2rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--surface);
            color: var(--foreground);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }
        
        .rating-btn i {
            font-size: 1.5rem;
        }
        
        .rating-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .know-btn {
            border-color: #4CAF50;
            color: #4CAF50;
        }
        
        .know-btn:hover:not(:disabled) {
            background: #4CAF50;
            color: white;
        }
        
        .know-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background: var(--surface);
            color: var(--text-muted);
            border-color: var(--border);
        }
        
        .unfamiliar-btn {
            border-color: #D32F2F;
            color: #D32F2F;
        }
        
        .unfamiliar-btn:hover:not(:disabled) {
            background: #D32F2F;
            color: white;
        }
        
        .unfamiliar-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background: var(--surface);
            color: var(--text-muted);
            border-color: var(--border);
        }
        
        .next-btn {
            border-color: var(--border-dark);
            color: var(--foreground);
        }
        
        .next-btn:hover:not(:disabled) {
            background: var(--foreground);
            color: var(--surface);
        }
        
        .next-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background: var(--surface);
            color: var(--text-muted);
            border-color: var(--border);
        }
        
        /* ä¼˜åŒ–çš„å†å²è®°å½•æ ·å¼ */
        .history-container {
            overflow: visible; /* ç¡®ä¿tooltipä¸è¢«å‰ªè£ */
            position: relative;
        }
        
        .history-words {
            overflow: visible; /* ç¡®ä¿tooltipä¸è¢«å‰ªè£ */
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .history-title {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .history-title i {
            color: var(--foreground);
            opacity: 0.7;
        }

        .history-stats {
            font-size: 0.85rem;
            color: var(--text-muted);
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .stat-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.9rem;
            border-radius: 16px;
            border: 2px solid;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .stat-badge i {
            font-size: 1rem;
        }

        /* å›¾ä¾‹æ ·å¼ */
        .history-legend {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
            padding: 0.5rem 0;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--foreground);
            font-weight: 500;
        }
        
        .legend-box {
            width: 16px;
            height: 16px;
            border-radius: 2px;
            border: 1px solid;
            display: inline-block;
        }
        
        .history-empty {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-muted);
        }
        
        .history-empty i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        .history-empty p {
            font-size: 1rem;
            margin: 0;
        }
        
        /* æ–¹å—ç½‘æ ¼å¸ƒå±€ */
        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(24px, 1fr));
            gap: 4px;
            padding: 1rem 0;
            max-width: 100%;
            overflow: visible; /* ç¡®ä¿tooltipä¸è¢«å‰ªè£ */
        }
        
        .history-box {
            width: 24px;
            height: 24px;
            border-radius: 3px;
            border: 1px solid var(--border);
            background: var(--surface);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        /* ç©ºç™½çŠ¶æ€ - å¾…å®Œæˆ */
        .history-box.empty {
            background: #e0e0e0;
            border: 1px dashed var(--border);
            opacity: 0.6;
        }
        
        .history-box.empty:hover {
            opacity: 0.8;
            border-style: solid;
        }
        
        /* è®¤è¯† - ç»¿è‰² */
        .history-box.known {
            background: #4CAF50;
            border-color: #388E3C;
        }
        
        /* ä¸ç†Ÿæ‚‰ - çº¢è‰² */
        .history-box.unfamiliar {
            background: #D32F2F;
            border-color: #B71C1C;
        }
        
        /* ç”¨æ—¶è¿‡é•¿ - æ©™è‰² */
        .history-box.slow {
            background: #FF9800;
            border-color: #F57C00;
        }
        
        .history-box:hover {
            transform: scale(1.3);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }
        
        /* æ‚¬åœæ—¶çš„è¯¦ç»†ä¿¡æ¯å¡ç‰‡ */
        .history-tooltip {
            position: fixed;
            background: var(--foreground);
            color: var(--surface);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            display: none;
            transition: opacity 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            min-width: 200px;
            max-width: 300px;
        }
        
        
        .tooltip-time {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #FFD54F;
        }
        
        .tooltip-question {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .tooltip-answer {
            color: #81C784;
        }
        
        /* å®Œæˆæç¤ºå¼¹çª— */
        .completion-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .completion-modal.show {
            opacity: 1;
            pointer-events: none; /* èƒŒæ™¯å…è®¸é¼ æ ‡ç©¿é€ */
        }
        
        .completion-modal.show .completion-content {
            pointer-events: auto; /* å†…å®¹å¡ç‰‡å“åº”é¼ æ ‡äº‹ä»¶ */
        }
        
        .completion-content {
            background: var(--surface);
            border-radius: 16px;
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .completion-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .completion-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--foreground);
        }

        .completion-stats {
            background: var(--surface-elevated);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            text-align: left;
        }
        
        .completion-stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }
        
        .completion-stat-item:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            color: var(--foreground);
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .stat-value.green {
            color: #4CAF50;
        }
        
        .stat-value.orange {
            color: #FF9800;
        }
        
        .stat-value.red {
            color: #D32F2F;
        }
        
        .completion-progress {
            margin: 1.5rem 0;
            padding: 1rem;
            background: var(--surface-elevated);
            border-radius: 8px;
            overflow: visible;
        }
        
        .completion-progress .history-grid {
            padding: 0.5rem 0;
        }
        
        .completion-message {
            font-size: 1rem;
            color: var(--text-muted);
            margin: 1.5rem 0;
            line-height: 1.6;
        }
        
        .completion-btn {
            background: var(--foreground);
            color: var(--surface);
            border: none;
            border-radius: 12px;
            padding: 1rem 3rem;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            margin-top: 1rem;
        }
        
        .completion-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        
        .completion-btn:active {
            transform: translateY(0);
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .study-card {
                padding: 2rem 1.5rem;
                min-height: 250px;
            }
            
            .question-text {
                font-size: 2rem;
            }
            
            .answer-content {
                font-size: 1.8rem;
            }
            
            .rating-buttons {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .rating-btn {
                max-width: 100%;
                flex-direction: row;
                justify-content: center;
            }
            
            .action-btn {
                padding: 0.9rem 2rem;
                font-size: 1rem;
            }
            
            .history-grid {
                grid-template-columns: repeat(auto-fill, minmax(20px, 1fr));
                gap: 3px;
            }
            
            .history-box {
                width: 20px;
                height: 20px;
            }
            
            .history-stats {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .study-card {
                padding: 1.5rem 1rem;
            }
            
            .question-text {
                font-size: 1.5rem;
            }
            
            .answer-content {
                font-size: 1.4rem;
            }
            
            .dwds-link {
                font-size: 0.85rem;
                padding: 0.5rem 1rem;
            }
            
            .history-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .completion-content {
                padding: 2rem 1.5rem;
            }
            
            .completion-icon {
                font-size: 3rem;
            }
            
            .completion-title {
                font-size: 1.5rem;
            }
            
            .stat-value {
                font-size: 1.2rem;
            }
            
            .completion-btn {
                padding: 0.9rem 2rem;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="german_index.html" class="nav-btn">â† è¿”å›ä¸»é¡µ</a>
        <h1>å¾·è¯­åè¯åŠå† è¯è€ƒæ ¸å™¨</h1>
        <div class="subtitle">åè¯å­¦ä¹  | å† è¯ç»ƒä¹  | å¤æ•°å½¢å¼ | åŒå‘è€ƒæ ¸ | ååº”è®¡æ—¶</div>

        <!-- æ¨¡å¼é€‰æ‹© -->
        <div class="option-group">
            <span class="option-label">è€ƒæ ¸æ¨¡å¼:</span>
            <div class="option-buttons">
                <button class="option-btn active" data-mode="de-to-cn">å¾·è¯­ â†’ ä¸­æ–‡</button>
                <button class="option-btn" data-mode="cn-to-de">ä¸­æ–‡ â†’ å¾·è¯­</button>
                <button class="option-btn" data-mode="de-to-plural">åè¯ â†’ å¤æ•°</button>
            </div>
        </div>

        <!-- å¡ç‰‡åŒºåŸŸ - å…¨æ–°è®¾è®¡ -->
        <div class="study-card" id="study-card">
            <!-- é—®é¢˜æ˜¾ç¤ºåŒº -->
            <div class="card-question-area">
                <div class="question-text" id="question-text">ç‚¹å‡»å¡ç‰‡å¼€å§‹å­¦ä¹ </div>
                <a href="#" id="dwds-link" class="dwds-link" target="_blank" style="display: none;">
                    <i class="fas fa-book-open"></i> DWDSè¯å…¸
                </a>
                </div>
            
            <!-- ç­”æ¡ˆæ˜¾ç¤ºåŒºï¼ˆåˆå§‹éšè—ï¼‰ -->
            <div class="card-answer-area" id="answer-area" style="display: none;">
                <div class="answer-divider"></div>
                <div class="answer-content" id="answer-content"></div>
            </div>
            
            <!-- ç­”é¢˜æŒ‰é’®ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰ -->
            <div class="rating-buttons" id="rating-buttons">
                <button class="rating-btn know-btn" id="know-btn">
                    <i class="fas fa-check-circle"></i>
                    <span>ç†Ÿæ‚‰</span>
                </button>
                <button class="rating-btn unfamiliar-btn" id="unfamiliar-btn">
                    <i class="fas fa-flag"></i>
                    <span>ä¸ç†Ÿæ‚‰</span>
                </button>
                <button class="rating-btn next-btn" id="next-btn" disabled>
                    <i class="fas fa-arrow-right"></i>
                    <span>ä¸‹ä¸€é¢˜</span>
                </button>
            </div>
        </div>

        <div class="tip">
            ğŸ’¡ æç¤ºï¼šæŸ¥çœ‹é¢˜ç›® â†’ æ€è€ƒç­”æ¡ˆ â†’ ç‚¹å‡»"ç†Ÿæ‚‰"æˆ–"ä¸ç†Ÿæ‚‰"æŸ¥çœ‹ç­”æ¡ˆ â†’ ç‚¹å‡»"ä¸‹ä¸€é¢˜"ç»§ç»­<br>
            æ”¯æŒä¸‰ç§æ¨¡å¼ï¼šå¾·è¯­â†’ä¸­æ–‡ã€ä¸­æ–‡â†’å¾·è¯­ï¼ˆå«å† è¯ï¼‰ã€åè¯â†’å¤æ•°å½¢å¼
        </div>

        <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div class="status">
            <div class="timer">æ—¶é—´: 00:00</div>
            <div class="counter">å·²å®Œæˆ: 0/0</div>
        </div>

        <!-- å·²è€ƒæ ¸è¯æ±‡æ¡† -->
        <div class="history-container">
            <div class="history-header">
                <div class="history-title">
                    <i class="fas fa-history"></i> ç»ƒä¹ å†å²
                </div>
                <div class="history-stats" id="history-stats"></div>
                <button class="clear-history-btn" id="clear-history-btn">
                    <i class="fas fa-trash-alt"></i> æ¸…ç©º
                </button>
            </div>
            <div class="history-legend">
                <span class="legend-item">
                    <span class="legend-box" style="background: var(--surface); border-color: var(--border);"></span>
                    å¾…å®Œæˆ
                </span>
                <span class="legend-item">
                    <span class="legend-box" style="background: #4CAF50; border-color: #388E3C;"></span>
                    è®¤è¯†
                </span>
                <span class="legend-item">
                    <span class="legend-box" style="background: #FF9800; border-color: #F57C00;"></span>
                    æ…¢é€Ÿ
                </span>
                <span class="legend-item">
                    <span class="legend-box" style="background: #D32F2F; border-color: #B71C1C;"></span>
                    ä¸ç†Ÿæ‚‰
                </span>
            </div>
        <div class="history-words" id="history-words">
            <!-- å·²è€ƒæ ¸çš„è¯æ±‡å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
                <div class="history-empty">
                    <i class="fas fa-inbox"></i>
                    <p>æš‚æ— ç»ƒä¹ è®°å½•</p>
                </div>
        </div>
        </div>
        
        <!-- é”®ç›˜å¿«æ·é”®æç¤º -->
        <div class="keyboard-hint">
            <kbd>ç©ºæ ¼</kbd> ä¸‹ä¸€é¢˜ | <kbd>D</kbd> æ‰“å¼€DWDSè¯å…¸ | åŒå‡»å•è¯æœ—è¯»
        </div>
        
        <div class="footer">
            <p>Â© 2025 å¾·è¯­å­¦ä¹ å·¥å…·é›† | è®¾è®¡ä¸å¼€å‘ï¼šTrae AI</p>
        </div>
    </div>
    
    <!-- å®Œæˆä¸€è½®çš„æç¤ºå¼¹çª— -->
    <div class="completion-modal" id="completion-modal">
        <div class="completion-content">
            <div class="completion-icon">ğŸ‰</div>
            <h2 class="completion-title">å®Œæˆä¸€è½®æ£€éªŒï¼</h2>
            <div class="completion-stats" id="completion-stats-content">
                <!-- ç»Ÿè®¡ä¿¡æ¯å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="completion-progress" id="completion-progress">
                <!-- è¿›åº¦å›¾å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <p class="completion-message" id="completion-message">
                <!-- é¼“åŠ±ä¿¡æ¯å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </p>
            <button class="completion-btn" id="completion-btn">
                <i class="fas fa-redo"></i> å¼€å§‹ä¸‹ä¸€è½®
            </button>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let nounsData = []; // åŸå§‹è¯æ±‡æ•°æ®
        let shuffledData = []; // æ‰“ä¹±åçš„è¯æ±‡æ•°æ®
        let currentMode = 'de-to-cn'; // é»˜è®¤æ¨¡å¼ï¼šå¾·è¯­ â†’ ä¸­æ–‡
        let currentQuestionIndex = 0;
        let currentAnswer = '';
        let startTime = 0;
        let timerInterval = null;
        let totalQuestions = 0;
        let completedQuestions = 0;
        let currentAnswered = false; // æ ‡è®°å½“å‰é¢˜æ˜¯å¦å·²å›ç­”
        let historyWords = []; // å·²è€ƒæ ¸çš„è¯æ±‡å†å²è®°å½•ï¼Œæ ¼å¼: {word: string, unfamiliar: boolean, time: number}
        let currentRoundAnswers = []; // å½“å‰è½®æ¬¡çš„æ‰€æœ‰ç­”é¢˜è®°å½•ï¼Œç”¨äºç»Ÿè®¡ï¼ˆç´¢å¼•å¯¹åº”é¢˜ç›®é¡ºåºï¼‰
        let completedRoundSnapshot = null; // å®Œæˆè½®æ¬¡çš„æ•°æ®å¿«ç…§ï¼Œé˜²æ­¢è¢«è¦†ç›–
        const MAX_HISTORY = 50; // æœ€å¤§å†å²è®°å½•æ•°é‡
        const SUPPORTED_VOICES = []; // æ”¯æŒçš„è¯­éŸ³åˆ—è¡¨

        // DOMå…ƒç´ ï¼ˆå»¶è¿Ÿè·å–ï¼Œé¿å…nullå¼•ç”¨ï¼‰
        let studyCard, questionText, dwdsLink, answerArea, answerContent;
        let ratingButtons, knowBtn, unfamiliarBtn, nextBtn;
        let timerDisplay, counterDisplay, historyWordsContainer, clearHistoryBtn;
        let completionModal, completionBtn, completionStatsContent, completionProgress, completionMessage;
        
        function initDOMElements() {
            studyCard = document.getElementById('study-card');
            questionText = document.getElementById('question-text');
            dwdsLink = document.getElementById('dwds-link');
            answerArea = document.getElementById('answer-area');
            answerContent = document.getElementById('answer-content');
            ratingButtons = document.getElementById('rating-buttons');
            knowBtn = document.getElementById('know-btn');
            unfamiliarBtn = document.getElementById('unfamiliar-btn');
            nextBtn = document.getElementById('next-btn');
            timerDisplay = document.querySelector('.timer');
            counterDisplay = document.querySelector('.counter');
            historyWordsContainer = document.getElementById('history-words');
            clearHistoryBtn = document.getElementById('clear-history-btn');
            completionModal = document.getElementById('completion-modal');
            completionBtn = document.getElementById('completion-btn');
            completionStatsContent = document.getElementById('completion-stats-content');
            completionProgress = document.getElementById('completion-progress');
            completionMessage = document.getElementById('completion-message');
        }

        // åˆå§‹åŒ–å‡½æ•°
        function init() {
            // åˆå§‹åŒ–DOMå…ƒç´ 
            initDOMElements();
            
            // ç›´æ¥ä½¿ç”¨åµŒå…¥çš„CSVæ•°æ®ï¼ˆé¿å…CORSé—®é¢˜ï¼‰
            const csvData = `noun,article,meaning,plural
Familienname,der,å§“,die Familiennamen
Name,der,åå­—,die Namen
Vorname,der,å,die Vornamen
Person,die,äºº,die Personen
Leute,die,äººä»¬,die Leute
Automechaniker,der,æ±½è½¦æœºæ¢°å¸ˆ,die Automechaniker
Automechanikerin,die,å¥³æ±½è½¦æœºæ¢°å¸ˆ,die Automechanikerinnen
Deutschlehrer,der,å¾·è¯­æ•™å¸ˆ,die Deutschlehrer
Deutschlehrerin,die,å¥³å¾·è¯­æ•™å¸ˆ,die Deutschlehrerinnen
SekretÃ¤r,der,ç§˜ä¹¦,die SekretÃ¤re
SekretÃ¤rin,die,å¥³ç§˜ä¹¦,die SekretÃ¤rinnen
Student,der,å¤§å­¦ç”Ÿ,die Studenten
Studentin,die,å¥³å¤§å­¦ç”Ÿ,die Studentinnen
KÃ¤ufer,der,é¡¾å®¢,die KÃ¤ufer
KÃ¤uferin,die,å¥³é¡¾å®¢,die KÃ¤uferinnen
VerkÃ¤ufer,der,å”®è´§å‘˜,die VerkÃ¤ufer
VerkÃ¤uferin,die,å¥³å”®è´§å‘˜,die VerkÃ¤uferinnen
Kunde,der,é¡¾å®¢,die Kunden
Kundin,die,å¥³é¡¾å®¢,die Kundinnen
Chef,der,ä¸»ç®¡äººå‘˜,die Chefs
Chefin,die,å¥³ä¸»ç®¡,die Chefinnen
Informatiker,der,è®¡ç®—æœºå·¥ç¨‹å¸ˆ,die Informatiker
Informatikerin,die,å¥³è®¡ç®—æœºå·¥ç¨‹å¸ˆ,die Informatikerinnen
Kursleiter,der,åŸ¹è®­ç­æ•™å¸ˆ,die Kursleiter
Kursleiterin,die,å¥³åŸ¹è®­ç­æ•™å¸ˆ,die Kursleiterinnen
Nachbar,der,é‚»å±…,die Nachbarn
Nachbarin,die,å¥³é‚»å±…,die Nachbarinnen
Eltern,die,çˆ¶æ¯,die Eltern
Sohn,der,å„¿å­,die SÃ¶hne
Tochter,die,å¥³å„¿,die TÃ¶chter
Kind,das,å­©å­,die Kinder
Erwachsene,der,æˆå¹´äºº,die Erwachsenen
Freundin,die,å¥³æœ‹å‹,die Freundinnen
Lernziel,das,å­¦ä¹ ç›®æ ‡,die Lernziele
Herkunft,die,å‡ºç”Ÿåœ°,die HerkÃ¼nfte
Sprache,die,è¯­è¨€,die Sprachen
Polnisch,das,æ³¢å…°è¯­,das Polnisch
Russisch,das,ä¿„ç½—æ–¯è¯­,das Russisch
Chinesisch,das,ä¸­æ–‡,das Chinesisch
Englisch,das,è‹±è¯­,das Englisch
FranzÃ¶sisch,das,æ³•è¯­,das FranzÃ¶sisch
Koreanisch,das,éŸ©è¯­,das Koreanisch
Persisch,das,æ³¢æ–¯è¯­,das Persisch
Spanisch,das,è¥¿ç­ç‰™è¯­,das Spanisch
TÃ¼rkisch,das,åœŸè€³å…¶è¯­,das TÃ¼rkisch
Ukrainisch,das,ä¹Œå…‹å…°è¯­,das Ukrainisch
Slowakisch,das,æ–¯æ´›ä¼å…‹è¯­,das Slowakisch
Estnisch,das,çˆ±æ²™å°¼äºšè¯­,das Estnisch
Schwedisch,das,ç‘å…¸è¯­,das Schwedisch
Sprachenname,der,è¯­è¨€åç§°,die Sprachennamen
Deutschkurs,der,å¾·è¯­åŸ¹è®­ç­,die Deutschkurse
Kurs,der,åŸ¹è®­ç­,die Kurse
Kursliste,die,å­¦å‘˜åå•,die Kurslisten
Liste,die,åˆ—è¡¨,die Listen
WÃ¶rterbuch,das,è¯å…¸,die WÃ¶rterbÃ¼cher
Wortliste,die,è¯æ±‡è¡¨,die Wortlisten
Wort,das,è¯,die WÃ¶rter
Satz,der,å¥å­,die SÃ¤tze
Aussagesatz,der,é™ˆè¿°å¥,die AussagesÃ¤tze
W-Frage,die,ç‰¹æ®Šç–‘é—®å¥,die W-Fragen
Beispiel,das,ä¾‹å­,die Beispiele
Verb,das,åŠ¨è¯,die Verben
Nomen,das,åè¯,die Nomen
Artikel,der,å† è¯,die Artikel
Fragewort,das,ç–‘é—®è¯,die FragewÃ¶rter
Grammatik,die,è¯­æ³•,die Grammatiken
Konjugation,die,åŠ¨è¯å˜ä½,die Konjugationen
Infinitiv,der,åŠ¨è¯ä¸å®šå¼,die Infinitive
Singular,der,å•æ•°,die Singulare
Plural,der,å¤æ•°,die Plurale
Endung,die,è¯å°¾,die Endungen
Akzent,der,é‡éŸ³,die Akzente
Aussprache,die,å‘éŸ³,die Aussprachen
Melodie,die,æ›²è°ƒ,die Melodien
Rhythmus,der,èŠ‚å¥,die Rhythmen
Vokal,der,å…ƒéŸ³,die Vokale
Konsonant,der,è¾…éŸ³,die Konsonanten
Wortakzent,der,è¯é‡éŸ³,die Wortakzente
Betonung,die,é‡éŸ³,die Betonungen
Dialog,der,å¯¹è¯,die Dialoge
Dialognummer,die,å¯¹è¯ç¼–å·,die Dialognummern
Text,der,è¯¾æ–‡,die Texte
Lernplakat,das,å­¦ä¹ æ‹›è´´ç”»,die Lernplakate
KÃ¤rtchen,das,å°å¡ç‰‡,die KÃ¤rtchen
Alphabet,das,å­—æ¯è¡¨,die Alphabete
Steckbrief,der,ç®€è¦è¯´æ˜,die Steckbriefe
Arbeitsanweisung,die,å·¥ä½œæŒ‡å¯¼,die Arbeitsanweisungen
Aufgabe,die,ç»ƒä¹ ,die Aufgaben
Ãœbung,die,ç»ƒä¹ ,die Ãœbungen
Rollenspiel,das,è§’è‰²æ‰®æ¼”,die Rollenspiele
Projekt,das,é¡¹ç›®,die Projekte
Suchwort,das,æœç´¢è¯,die SuchwÃ¶rter
Information,die,ä¿¡æ¯,die Informationen
RÃ¼ckfrage,die,åé—®,die RÃ¼ckfragen
Zeitangabe,die,æ—¶é—´è¯´æ˜,die Zeitangaben
Wortteil,der,è¯çš„ç»„æˆéƒ¨åˆ†,die Wortteile
Satzklammer,die,å¥å­æ¡†å‹ç»“æ„,die Satzklammern
Vergangenheitsform,die,è¿‡å»æ—¶æ€,die Vergangenheitsformen
Vergangenheit,die,è¿‡å»,die Vergangenheiten
Land,das,å›½å®¶,die LÃ¤nder
Stadt,die,åŸå¸‚,die StÃ¤dte
Wohnort,der,å±…ä½åœ°,die Wohnorte
Haus,das,æˆ¿å­,die HÃ¤user
Wohnung,die,å…¬å¯“,die Wohnungen
Ecke,die,è§’è½,die Ecken
Firma,die,å…¬å¸,die Firmen
Kantine,die,é¤å…é£Ÿå ‚,die Kantinen
BÃ¼ro,das,åŠå…¬å®¤,die BÃ¼ros
Kursraum,der,æ•™å®¤,die KursrÃ¤ume
Schule,die,å­¦æ ¡,die Schulen
Grundschule,die,å°å­¦,die Grundschulen
Kinderkrippe,die,æ‰˜å„¿æ‰€,die Kinderkrippen
Supermarkt,der,è¶…å¸‚,die SupermÃ¤rkte
Flohmarkt,der,è·³èš¤å¸‚åœº,die FlohmÃ¤rkte
CafÃ©,das,å’–å•¡é¦†,die CafÃ©s
Cafeteria,die,å’–å•¡é¦†,die Cafeterias
Biergarten,der,éœ²å¤©å•¤é…’é¦†,die BiergÃ¤rten
Park,der,å…¬å›­,die Parks
FuÃŸgÃ¤ngerzone,die,æ­¥è¡ŒåŒº,die FuÃŸgÃ¤ngerzonen
Rathaus,das,å¸‚æ”¿å…,die RathÃ¤user
Museum,das,åšç‰©é¦†,die Museen
Schwimmbad,das,æ¸¸æ³³åœº,die SchwimmbÃ¤der
Theater,das,å‰§é™¢,die Theater
Kino,das,ç”µå½±é™¢,die Kinos
Zirkus,der,é©¬æˆå›¢,die Zirkusse
BÃ¤ckerei,die,é¢åŒ…æˆ¿,die BÃ¤ckereien
Bibliothek,die,å›¾ä¹¦é¦†,die Bibliotheken
Metzgerei,die,è‚‰é“º,die Metzgereien
Region,die,åœ°åŒº,die Regionen
Gleis,das,ç«™å°,die Gleise
Treffpunkt,der,é›†åˆç‚¹,die Treffpunkte
Bleistift,der,é“…ç¬”,die Bleistifte
Kuli,der,åœ†ç ç¬”,die Kulis
Kugelschreiber,der,åœ†ç ç¬”,die Kugelschreiber
Computer,der,è®¡ç®—æœº,die Computer
Drucker,der,æ‰“å°æœº,die Drucker
Fernseher,der,ç”µè§†,die Fernseher
Herd,der,ç‚‰ç¶,die Herde
MP3-Player,der,MP3æ’­æ”¾å™¨,die MP3-Player
Stuhl,der,æ¤…å­,die StÃ¼hle
Tisch,der,æ¡Œå­,die Tische
Wasserkocher,der,ç”µçƒ­æ°´å£¶,die Wasserkocher
DVD,die,DVDå…‰ç›˜,die DVDs
Kaffeemaschine,die,å’–å•¡æœº,die Kaffeemaschinen
Lampe,die,ç¯,die Lampen
Schere,die,å‰ªåˆ€,die Scheren
Waschmaschine,die,æ´—è¡£æœº,die Waschmaschinen
BÃ¼geleisen,das,ç†¨æ–—,die BÃ¼geleisen
Tasche,die,åŒ…,die Taschen
Buch,das,ä¹¦,die BÃ¼cher
Brille,die,çœ¼é•œ,die Brillen
Fahrrad,das,è‡ªè¡Œè½¦,die FahrrÃ¤der
Kinderwagen,der,ç«¥è½¦,die Kinderwagen
KÃ¼hlschrank,der,å†°ç®±,die KÃ¼hlschrÃ¤nke
Staubsauger,der,å¸å°˜å™¨,die Staubsauger
Monitor,der,æ˜¾ç¤ºå™¨,die Monitore
Digitalkamera,die,æ•°ç ç›¸æœº,die Digitalkameras
Kamera,die,ç›¸æœº,die Kameras
CD,die,å…‰ç›˜,die CDs
Papierkorb,der,çº¸ç¯“,die PapierkÃ¶rbe
Uhr,die,é’Ÿè¡¨,die Uhren
Telefonnummer,die,ç”µè¯å·ç ,die Telefonnummern
Handynummer,die,æ‰‹æœºå·ç ,die Handynummern
Vorwahl,die,åŒºå·,die Vorwahlen
Telefon,das,ç”µè¯,die Telefone
E-Mail,die,ç”µå­é‚®ä»¶,die E-Mails
E-Mail-Adresse,die,ç”µå­é‚®ä»¶åœ°å€,die E-Mail-Adressen
Postleitzahl,die,é‚®æ”¿ç¼–ç ,die Postleitzahlen
Adresse,die,åœ°å€,die Adressen
Handy,das,æ‰‹æœº,die Handys
Telefonbuch,das,ç”µè¯ç°¿,die TelefonbÃ¼cher
Mineralwasser,das,çŸ¿æ³‰æ°´,die Mineralwasser
Wasser,das,æ°´,das Wasser
Kaffee,der,å’–å•¡,die Kaffees
Tee,der,èŒ¶,die Tees
Zucker,der,ç³–,der Zucker
Milch,die,ç‰›å¥¶,die Milch
Orangensaft,der,æ©˜å­æ±,die OrangensÃ¤fte
Saft,der,æœæ±,die SÃ¤fte
Joghurt,der,é…¸å¥¶,die Joghurts
Peperoni,die,è¾£æ¤’,die Peperonis
Salami,die,æ„å¤§åˆ©é¦™è‚ ,die Salamis
Tomate,die,è¥¿çº¢æŸ¿,die Tomaten
Cappuccino,der,å¡å¸ƒå¥‡è¯º,die Cappuccinos
Cola,die,å¯ä¹,die Colas
GetrÃ¤nk,das,é¥®æ–™,die GetrÃ¤nke
Espresso,der,æµ“å’–å•¡,die Espressos
BrÃ¶tchen,das,å°é¢åŒ…,die BrÃ¶tchen
Kaffeekanne,die,å’–å•¡å£¶,die Kaffeekannen
Teekanne,die,èŒ¶å£¶,die Teekannen
Thermoskanne,die,ä¿æ¸©å£¶,die Thermoskannen
Seite,die,ä¹¦é¡µ,die Seiten
Geldschein,der,çº¸å¸,die Geldscheine
EuromÃ¼nze,die,æ¬§å…ƒç¡¬å¸,die EuromÃ¼nzen
Eurozone,die,æ¬§å…ƒåŒº,die Eurozonen
Cent,der,æ¬§åˆ†,die Cents
Euro,der,æ¬§å…ƒ,die Euros
Tablett,das,æ‰˜ç›˜,die Tabletts
Kasse,die,é’±ç®±,die Kassen
Bild,das,å›¾ç”»,die Bilder
Foto,das,ç…§ç‰‡,die Fotos
Zettel,der,çº¸æ¡,die Zettel
Karte,die,å¡ç‰‡,die Karten
Tabelle,die,è¡¨æ ¼,die Tabellen
Tag,der,æ—¥,die Tage
Abend,der,æ™šä¸Š,die Abende
Morgen,der,æ—©ä¸Š,die Morgen
Mittag,der,ä¸­åˆ,die Mittage
Nachmittag,der,ä¸‹åˆ,die Nachmittage
Vormittag,der,ä¸Šåˆ,die Vormittage
Nacht,die,å¤œæ™š,die NÃ¤chte
Woche,die,æ˜ŸæœŸ,die Wochen
Wochentag,der,å·¥ä½œæ—¥,die Wochentage
Wochenende,das,å‘¨æœ«,die Wochenenden
Arbeitswoche,die,å·¥ä½œå‘¨,die Arbeitswochen
Arbeitstag,der,å·¥ä½œæ—¥,die Arbeitstage
Jahr,das,å¹´,die Jahre
Minute,die,åˆ†é’Ÿ,die Minuten
Stunde,die,å°æ—¶,die Stunden
Uhrzeit,die,æ—¶é—´,die Uhrzeiten
Tageszeit,die,ç™½å¤©æ—¶é—´,die Tageszeiten
Tagesablauf,der,æ—¥å¸¸å®‰æ’,die TagesablÃ¤ufe
Alltag,der,æ—¥å¸¸ç”Ÿæ´»,die Alltage
Alltagssprache,die,æ—¥å¸¸ç”¨è¯­,die Alltagssprachen
Beruf,der,èŒä¸š,die Berufe
Praktikum,das,å®ä¹ ,die Praktika
AktivitÃ¤t,die,æ´»åŠ¨,die AktivitÃ¤ten
Konzert,das,éŸ³ä¹ä¼š,die Konzerte
Film,der,ç”µå½±,die Filme
Krimi,der,ä¾¦æ¢ç‰‡,die Krimis
Fernsehprogramm,das,ç”µè§†èŠ‚ç›®,die Fernsehprogramme
Verabredung,die,çº¦ä¼š,die Verabredungen
Interview,das,é‡‡è®¿,die Interviews
VerkaufsgesprÃ¤ch,das,è´­ç‰©è°ˆè¯,die VerkaufsgesprÃ¤che
GesprÃ¤ch,das,è°ˆè¯,die GesprÃ¤che
Kleinanzeige,die,å°å¹¿å‘Š,die Kleinanzeigen
Anzeige,die,å¹¿å‘Š,die Anzeigen
Ansage,die,ä¸»æŒèŠ‚ç›®,die Ansagen
Stadtfest,das,åŸå¸‚èŠ‚æ—¥,die Stadtfeste
Sport,der,ä½“è‚²è¿åŠ¨,die Sportarten
Fitness,die,å¥åº·,die Fitness
Musik,die,éŸ³ä¹,die Musik
Kinderachen,die,ç«¥è£…,die Kinderachen
Sache,die,äº‹ç‰©,die Sachen
SpÃ¼lmaschine,die,æ´—ç¢—æœº,die SpÃ¼lmaschinen
Gegenstand,der,ä¸œè¥¿,die GegenstÃ¤nde
Preis,der,ä»·æ ¼,die Preise
QualitÃ¤t,die,è´¨é‡,die QualitÃ¤ten
SchnÃ¤ppchen,das,å»‰ä»·å“,die SchnÃ¤ppchen
Ziffer,die,æ•°å­—,die Ziffern
Zahl,die,æ•°å­—,die Zahlen
Tipp,der,å»ºè®®,die Tipps
Angebot,das,æä¾›,die Angebote
Schrank,der,æŸœå­,die SchrÃ¤nke
Entschuldigung,die,æŠ±æ­‰,die Entschuldigungen
Frau,die,å¥³å£«,die Frauen
Herr,der,å…ˆç”Ÿ,die Herren
Personalpronomen,das,äººç§°ä»£è¯,die Personalpronomen
Position,die,ä½ç½®,die Positionen
Verbposition,die,åŠ¨è¯ä½ç½®,die Verbpositionen
Frage,die,é—®é¢˜,die Fragen
Antwort,die,å›ç­”,die Antworten
Pause,die,ä¼‘æ¯,die Pausen
Krankheit,die,ç—…,die Krankheiten
Lust,die,å…´è¶£,die Lust
TÃ¼r,die,é—¨,die TÃ¼ren
Polizei,die,è­¦å¯Ÿ,die Polizei
Bus,der,å…¬å…±æ±½è½¦,die Busse
ICE,der,åŸé™…å¿«è½¦,die ICEs
Moment,der,ç‰‡åˆ»,die Momente
Nummer,die,å·ç ,die Nummern`;
            
            // ä½¿ç”¨PapaParseè§£æCSVå­—ç¬¦ä¸²
            Papa.parse(csvData, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    console.log('CSVè§£ææˆåŠŸï¼Œå…±', results.data.length, 'æ¡æ•°æ®');
                    nounsData = results.data.filter(row => row.noun && row.article && row.meaning && row.plural);
                    totalQuestions = nounsData.length;
                    updateCounter();
                    // åˆå§‹åŒ–æ‰“ä¹±çš„æ•°æ®å¹¶ç”Ÿæˆç¬¬ä¸€ä¸ªé—®é¢˜
                    shuffleQuestions();
                    generateQuestion();
                    // åˆå§‹åŒ–æ˜¾ç¤ºæ‰€æœ‰æ–¹å—
                    updateHistoryDisplay();
                },
                error: function(error) {
                    console.error('CSVè§£æå¤±è´¥:', error);
                    if (questionText) {
                        questionText.textContent = 'CSVæ•°æ®è§£æå¤±è´¥';
                    }
                }
            });

            // é¢„åŠ è½½è¯­éŸ³åˆ—è¡¨
            loadVoices();
            
            // ç›‘å¬è¯­éŸ³åˆ—è¡¨å˜åŒ–
            if ('speechSynthesis' in window) {
                window.speechSynthesis.onvoiceschanged = loadVoices;
            }
            
            // æ¨¡å¼é€‰æ‹©äº‹ä»¶ç›‘å¬
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // æ›´æ–°æ´»åŠ¨çŠ¶æ€
                    document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // æ›´æ–°æ¨¡å¼
                    currentMode = this.getAttribute('data-mode');
                    
                    // é‡ç½®å¹¶å¼€å§‹æ–°ä¸€è½®ç»ƒä¹ 
                    resetExercise();
                    
                    // ç¡®ä¿æ¨¡å¼æŒ‰é’®ä¿æŒå¯è§
                    document.querySelector('.option-buttons').style.display = 'flex';
                });
            });

            // å¡ç‰‡ç‚¹å‡»äº‹ä»¶ - å¼€å§‹æ–°é¢˜
            if (studyCard) {
                studyCard.addEventListener('click', function(e) {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯DWDSé“¾æ¥æˆ–æŒ‰é’®ï¼Œä¸è§¦å‘
                    if (e.target.closest('.dwds-link') || e.target.closest('button')) {
                        return;
                    }
                    // åªæœ‰åœ¨åˆå§‹çŠ¶æ€æˆ–æ˜¾ç¤ºç­”æ¡ˆåæ‰å“åº”å¡ç‰‡ç‚¹å‡»
                    if (!studyCard.classList.contains('has-question') || ratingButtons.style.display !== 'none') {
                showQuestion();
                    }
                });
            }
            
            // ç†Ÿæ‚‰æŒ‰é’®
            if (knowBtn) {
                knowBtn.addEventListener('click', function() {
                    if (!currentAnswered) {
                        showAnswer(); // æ˜¾ç¤ºç­”æ¡ˆ
                        recordAnswer(false); // è®°å½•ä¸ºç†Ÿæ‚‰
                        enableNextButton(); // å¯ç”¨ä¸‹ä¸€é¢˜æŒ‰é’®
                        currentAnswered = true; // æ ‡è®°å·²å›ç­”
                    }
                });
            }
            
            // ä¸ç†Ÿæ‚‰æŒ‰é’®
            if (unfamiliarBtn) {
                unfamiliarBtn.addEventListener('click', function() {
                    if (!currentAnswered) {
                        showAnswer(); // æ˜¾ç¤ºç­”æ¡ˆ
                        recordAnswer(true); // è®°å½•ä¸ºä¸ç†Ÿæ‚‰
                        enableNextButton(); // å¯ç”¨ä¸‹ä¸€é¢˜æŒ‰é’®
                        currentAnswered = true; // æ ‡è®°å·²å›ç­”
                    }
                });
            }
            
            // ä¸‹ä¸€é¢˜æŒ‰é’®
            if (nextBtn) {
                nextBtn.addEventListener('click', function() {
                    if (!nextBtn.disabled) {
                        showQuestion(); // è¿›å…¥ä¸‹ä¸€é¢˜
                    }
                });
            }
            
            // æ¸…ç©ºå†å²è®°å½•æŒ‰é’®
            if (clearHistoryBtn) {
                clearHistoryBtn.addEventListener('click', clearHistory);
            }
            
            // å®Œæˆä¸€è½®æŒ‰é’®
            if (completionBtn) {
                completionBtn.addEventListener('click', startNewRound);
            }
            
            // é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', function(e) {
                // ç©ºæ ¼é”®ï¼šæ˜¾ç¤ºç­”æ¡ˆ æˆ– ä¸‹ä¸€é¢˜
                if (e.code === 'Space') {
                    e.preventDefault();
                    if (showAnswerBtn && showAnswerBtn.style.display !== 'none') {
                        showAnswerBtn.click();
                    } else if (ratingButtons && ratingButtons.style.display !== 'none') {
                        knowBtn.click(); // é»˜è®¤"è®¤è¯†"å¹¶è¿›å…¥ä¸‹ä¸€é¢˜
                    }
                }
                // Dé”®ï¼šæ‰“å¼€DWDSè¯å…¸
                else if (e.code === 'KeyD' && dwdsLink && dwdsLink.style.display !== 'none') {
                    e.preventDefault();
                    dwdsLink.click();
                }
            });
            
            // æ·»åŠ å¾·è¯­å•è¯åŒå‡»æœ—è¯»åŠŸèƒ½
            if (questionText) {
                questionText.addEventListener('dblclick', function() {
                // åœ¨å¾·è¯­â†’ä¸­æ–‡æ¨¡å¼æˆ–å¤æ•°æ¨¡å¼ä¸‹ï¼Œæœ—è¯»é—®é¢˜ä¾§çš„å¾·è¯­å•è¯
                    if ((currentMode === 'de-to-cn' || currentMode === 'de-to-plural') && questionText.textContent !== 'ç‚¹å‡»å¡ç‰‡å¼€å§‹å­¦ä¹ ') {
                        speakText(questionText.textContent.trim(), 'de-DE');
                    }
                });
            }
            
            // ç­”æ¡ˆå†…å®¹åŒå‡»æœ—è¯»
            if (answerContent) {
                answerContent.addEventListener('dblclick', function() {
                    const text = answerContent.textContent.trim();
                    if (text) {
                            // å¦‚æœæ˜¯ä¸­æ–‡â†’å¾·è¯­æ¨¡å¼ã€å¤æ•°æ¨¡å¼æˆ–è€…åŒ…å«å¾·è¯­å† è¯ï¼Œä½¿ç”¨å¾·è¯­æœ—è¯»
                            if (currentMode === 'cn-to-de' || currentMode === 'de-to-plural' || text.match(/^(der|die|das) /)) {
                                speakText(text, 'de-DE');
                            } else {
                                speakText(text, 'zh-CN');
                        }
                    }
                });
            }
            

        }

        // æ‰“ä¹±é—®é¢˜é¡ºåº
        function shuffleQuestions() {
            // åˆ›å»ºåŸå§‹æ•°æ®çš„æ·±æ‹·è´
            shuffledData = JSON.parse(JSON.stringify(nounsData));
            // Fisher-Yates æ´—ç‰Œç®—æ³•
            for (let i = shuffledData.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledData[i], shuffledData[j]] = [shuffledData[j], shuffledData[i]];
            }
        }
        
        // é‡ç½®ç»ƒä¹ 
        function resetExercise() {
            resetCard();
            completedQuestions = 0;
            updateCounter();
            // æ‰“ä¹±è¯æ±‡é¡ºåºå¼€å§‹æ–°ä¸€è½®ç»ƒä¹ 
            shuffleQuestions();
            generateQuestion();
            // æ¸…ç©ºå†å²è®°å½•
            historyWords = [];
            currentRoundAnswers = []; // æ¸…ç©ºå½“å‰è½®æ¬¡è®°å½•
            updateHistoryDisplay();
        }
        
        // ç”Ÿæˆé—®é¢˜
        function generateQuestion() {
            resetCard();
            currentAnswered = false; // é‡ç½®å›ç­”çŠ¶æ€
            if (shuffledData.length === 0) return;
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦å¼€å§‹æ–°ä¸€è½®ç»ƒä¹ 
            if (completedQuestions >= totalQuestions) {
                // å®Œæˆä¸€è½®ç»ƒä¹ ï¼Œå¼€å§‹æ–°çš„ä¸€è½®
                shuffleQuestions();
                completedQuestions = 0;
                updateCounter();
            }
            
            // æŒ‰é¡ºåºè·å–ä¸‹ä¸€ä¸ªé—®é¢˜ï¼ˆç¡®ä¿ä¸é‡å¤ï¼‰
            currentQuestionIndex = completedQuestions;
            const currentItem = shuffledData[currentQuestionIndex];
            
            // æ ¹æ®æ¨¡å¼è®¾ç½®é—®é¢˜å’Œç­”æ¡ˆ
            if (currentMode === 'de-to-cn') {
                // å¾·è¯­ â†’ ä¸­æ–‡
                if (questionText) {
                    questionText.textContent = currentItem.noun;
                }
                currentAnswer = currentItem.meaning;
                // è‡ªåŠ¨æœ—è¯»å¾·è¯­å•è¯
                speakText(currentItem.noun, 'de-DE');
                // è®¾ç½®DWDSé“¾æ¥
                updateDWDSLink(currentItem.noun);
            } else if (currentMode === 'de-to-plural') {
                // åè¯ â†’ å¤æ•°å½¢å¼
                if (questionText) {
                    questionText.textContent = `${currentItem.article} ${currentItem.noun}`;
                }
                currentAnswer = currentItem.plural;
                // è‡ªåŠ¨æœ—è¯»å¾·è¯­å•è¯ï¼ˆå•æ•°ï¼‰
                speakText(`${currentItem.article} ${currentItem.noun}`, 'de-DE');
                // è®¾ç½®DWDSé“¾æ¥
                updateDWDSLink(currentItem.noun);
            } else {
                // ä¸­æ–‡ â†’ å¾·è¯­ï¼ˆå¸¦å† è¯ï¼‰
                if (questionText) {
                    questionText.textContent = currentItem.meaning;
                }
                currentAnswer = `${currentItem.article} ${currentItem.noun}`;
                // è®¾ç½®DWDSé“¾æ¥
                updateDWDSLink(currentItem.noun);
            }
            
            // éšè—ç­”æ¡ˆåŒºåŸŸ
            if (answerArea) {
                answerArea.style.display = 'none';
            }
            
            // ç¡®ä¿æŒ‰é’®æ˜¾ç¤ºä¸”ä¸‹ä¸€é¢˜æŒ‰é’®ç¦ç”¨
            if (ratingButtons) {
                ratingButtons.style.display = 'flex';
            }
            if (nextBtn) {
                nextBtn.disabled = true;
            }
            
            // æ ‡è®°å¡ç‰‡æœ‰é—®é¢˜
            if (studyCard) {
                studyCard.classList.add('has-question');
            }
            
            // é‡ç½®è®¡æ—¶å™¨
            resetTimer();
            startTimer();
        }

        // æ›´æ–°DWDSè¯å…¸é“¾æ¥
        function updateDWDSLink(noun) {
            if (!noun || !dwdsLink) {
                console.log('DWDSé“¾æ¥æ›´æ–°è·³è¿‡ï¼š', {noun, dwdsLinkExists: !!dwdsLink});
                return;
            }
            
            // æ¸…ç†åè¯ï¼ˆç§»é™¤å† è¯å’Œç‰¹æ®Šå­—ç¬¦ï¼‰
            const cleanNoun = noun.replace(/^(der|die|das)\s+/, '').trim();
            // DWDSè¯å…¸é“¾æ¥æ ¼å¼
            const dwdsUrl = `https://www.dwds.de/wb/${encodeURIComponent(cleanNoun)}`;
            dwdsLink.href = dwdsUrl;
            dwdsLink.style.display = 'inline-block';
            console.log('DWDSé“¾æ¥å·²æ›´æ–°ï¼š', dwdsUrl);
        }
        
        // æ¸…ç©ºå†å²è®°å½•
        function clearHistory() {
            if (historyWords.length === 0) return;
            
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) {
                historyWords = [];
                updateHistoryDisplay();
            }
        }

        // æ˜¾ç¤ºé—®é¢˜
        function showQuestion() {
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ç‚¹å‡»æˆ–å·²å®Œæˆæ‰€æœ‰é—®é¢˜ï¼Œé‡ç½®ç»ƒä¹ 
            if (completedQuestions === 0 || completedQuestions >= totalQuestions) {
                resetExercise();
            } else {
                // ç”Ÿæˆé—®é¢˜
                generateQuestion();
                
                // å†å²è®°å½•å°†åœ¨showAnswerå‡½æ•°ä¸­æ·»åŠ ï¼Œä»¥ä¾¿æ­£ç¡®æ ‡è®°ä¸ç†Ÿæ‚‰å•è¯
            }
            // æ¢å¤è®¡æ—¶å™¨å¯åŠ¨
            startTimer();
        }


        
        // æ–‡æœ¬æœ—è¯»å‡½æ•°
        function speakText(text, language = 'de-DE') {
            
            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒWeb Speech API
            if ('speechSynthesis' in window) {
                // åœæ­¢ä»»ä½•æ­£åœ¨è¿›è¡Œçš„è¯­éŸ³
                window.speechSynthesis.cancel();
                
                // åˆ›å»ºè¯­éŸ³å®ä¾‹
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = language;
                utterance.rate = 0.9; // ç¨å¾®æ”¾æ…¢è¯­é€Ÿ
                
                // å¦‚æœæœ‰å¾·è¯­è¯­éŸ³ï¼Œä¼˜å…ˆä½¿ç”¨
                if (SUPPORTED_VOICES.length > 0) {
                    const germanVoice = SUPPORTED_VOICES.find(voice => 
                        voice.lang === 'de-DE' || voice.lang.startsWith('de-')
                    );
                    if (germanVoice) {
                        utterance.voice = germanVoice;
                    }
                }
                
                // å¼€å§‹æœ—è¯»
                window.speechSynthesis.speak(utterance);
            }
        }
        
        // é¢„åŠ è½½è¯­éŸ³åˆ—è¡¨
        function loadVoices() {
            if ('speechSynthesis' in window) {
                const voices = window.speechSynthesis.getVoices();
                SUPPORTED_VOICES.length = 0;
                SUPPORTED_VOICES.push(...voices);
            }
        }
        
        // æ˜¾ç¤ºç­”æ¡ˆ
        function showAnswer() {
            // åœæ­¢è®¡æ—¶å™¨
            stopTimer();
            
            // æ˜¾ç¤ºç­”æ¡ˆå†…å®¹
            if (answerContent) {
                answerContent.textContent = currentAnswer;
            }
            if (answerArea) {
                answerArea.style.display = 'block';
            }
            
            // åœ¨ä¸­æ–‡â†’å¾·è¯­æ¨¡å¼æˆ–å¤æ•°æ¨¡å¼ä¸‹ï¼Œæœ—è¯»å¾·è¯­ç­”æ¡ˆ
            if (currentMode === 'cn-to-de' || currentMode === 'de-to-plural') {
                speakText(currentAnswer, 'de-DE');
            }
        }
        
        // è®°å½•ç­”æ¡ˆï¼ˆç”¨äºè¯„ä»·æŒ‰é’®ï¼‰
        function recordAnswer(isUnfamiliar = false) {
            // æ·»åŠ å®‰å…¨æ£€æŸ¥é˜²æ­¢å¼‚å¸¸å¤§å€¼
            const elapsedTime = startTime ? Math.max(0, Math.floor((Date.now() - startTime) / 1000)) : 0;
            
            // å¢åŠ å®Œæˆè®¡æ•°
                completedQuestions++;
                updateCounter();
                
                // è·å–å½“å‰è¦æ·»åŠ åˆ°å†å²è®°å½•çš„å•è¯
                const currentItem = shuffledData[currentQuestionIndex];
                let historyWord;
                if (currentMode === 'de-to-cn') {
                    historyWord = currentItem.noun;
                } else if (currentMode === 'de-to-plural') {
                    historyWord = `${currentItem.article} ${currentItem.noun}`;
                } else {
                    historyWord = currentItem.meaning;
                }
                
            // æ·»åŠ åˆ°å†å²è®°å½•ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰ï¼ŒåŒ…å«æ—¶é—´ä¿¡æ¯
            addToHistory(historyWord, isUnfamiliar, elapsedTime);
            
            // æ·»åŠ åˆ°å½“å‰è½®æ¬¡è®°å½•ï¼ˆç”¨äºç»Ÿè®¡ï¼‰ï¼ŒæŒ‰ç­”é¢˜é¡ºåºå­˜å‚¨ï¼ˆä»å·¦åˆ°å³ï¼‰
            // ä½¿ç”¨completedQuestions - 1ä½œä¸ºç´¢å¼•ï¼Œå› ä¸ºcompletedQuestionså·²ç»+1äº†
            const answerIndex = completedQuestions - 1;
            let questionDisplay, answerDisplay;
            if (currentMode === 'de-to-cn') {
                questionDisplay = currentItem.noun;
                answerDisplay = currentItem.meaning;
            } else if (currentMode === 'de-to-plural') {
                questionDisplay = `${currentItem.article} ${currentItem.noun}`;
                answerDisplay = currentItem.plural;
            } else {
                questionDisplay = currentItem.meaning;
                answerDisplay = `${currentItem.article} ${currentItem.noun}`;
            }
            
            currentRoundAnswers[answerIndex] = {
                word: historyWord,
                unfamiliar: isUnfamiliar,
                time: elapsedTime,
                question: questionDisplay,
                answer: answerDisplay,
                meaning: currentItem.meaning
            };
            
            // ç«‹å³æ›´æ–°å†å²æ˜¾ç¤º
            updateHistoryDisplay();
            
            // æ£€æŸ¥æ˜¯å¦å®Œæˆäº†ä¸€è½®
            if (completedQuestions >= totalQuestions) {
                // ç«‹å³ä¿å­˜å½“å‰è½®æ¬¡çš„æ•°æ®å¿«ç…§ï¼Œé˜²æ­¢è¢«ä¸‹ä¸€è½®è¦†ç›–
                completedRoundSnapshot = JSON.parse(JSON.stringify(currentRoundAnswers));
                
                // ç¦ç”¨ä¸‹ä¸€é¢˜æŒ‰é’®ï¼Œé˜²æ­¢è¯¯æ“ä½œè¿›å…¥ä¸‹ä¸€è½®
                if (nextBtn) {
                    nextBtn.disabled = true;
                }
                
                // å»¶è¿Ÿæ˜¾ç¤ºå¼¹çª—ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æœ€åä¸€é¢˜çš„ç»“æœ
                setTimeout(showCompletionModal, 500);
            }
        }
        
        // æ˜¾ç¤ºå®Œæˆä¸€è½®çš„å¼¹çª—
        function showCompletionModal() {
            if (!completionModal || !completionStatsContent || !completionMessage) return;
            
            // æ¸…ç†æ—§çš„tooltipå…ƒç´ 
            const oldTooltips = document.querySelectorAll('.history-tooltip');
            oldTooltips.forEach(tooltip => tooltip.remove());
            
            // ä½¿ç”¨å¿«ç…§æ•°æ®è¿›è¡Œç»Ÿè®¡ï¼Œé˜²æ­¢è¢«æ–°ä¸€è½®è¦†ç›–
            const roundData = completedRoundSnapshot || currentRoundAnswers;
            
            // è®¡ç®—ç»Ÿè®¡æ•°æ®
            const times = roundData.map(item => item.time);
            const mean = times.length > 0 ? times.reduce((sum, time) => sum + time, 0) / times.length : 0;
            const variance = times.length > 0 ? times.reduce((sum, time) => sum + Math.pow(time - mean, 2), 0) / times.length : 0;
            const threshold = mean + Math.sqrt(variance);
            
            // ä»è½®æ¬¡è®°å½•ä¸­ç»Ÿè®¡å„ç±»ç­”é¢˜
            const unfamiliarCount = roundData.filter(item => item.unfamiliar).length;
            const slowCount = roundData.filter(item => !item.unfamiliar && item.time > threshold && roundData.length > 3).length;
            const knownCount = roundData.length - unfamiliarCount - slowCount;
            const accuracy = roundData.length > 0 ? ((knownCount / roundData.length) * 100).toFixed(1) : 0;
            
            // ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯HTML
            completionStatsContent.innerHTML = `
                <div class="completion-stat-item">
                    <span class="stat-label">
                        <i class="fas fa-check-circle" style="color: #4CAF50;"></i>
                        è®¤è¯†
                    </span>
                    <span class="stat-value green">${knownCount}</span>
                </div>
                ${slowCount > 0 ? `
                <div class="completion-stat-item">
                    <span class="stat-label">
                        <i class="fas fa-clock" style="color: #FF9800;"></i>
                        æ…¢é€Ÿ
                    </span>
                    <span class="stat-value orange">${slowCount}</span>
                </div>
                ` : ''}
                ${unfamiliarCount > 0 ? `
                <div class="completion-stat-item">
                    <span class="stat-label">
                        <i class="fas fa-times-circle" style="color: #D32F2F;"></i>
                        ä¸ç†Ÿæ‚‰
                    </span>
                    <span class="stat-value red">${unfamiliarCount}</span>
                </div>
                ` : ''}
                <div class="completion-stat-item">
                    <span class="stat-label">
                        <i class="fas fa-chart-line"></i>
                        æŒæ¡ç‡
                    </span>
                    <span class="stat-value" style="color: ${accuracy >= 80 ? '#4CAF50' : accuracy >= 60 ? '#FF9800' : '#D32F2F'};">
                        ${accuracy}%
                    </span>
                </div>
            `;
            
            // ç”Ÿæˆé¼“åŠ±ä¿¡æ¯
            let message = '';
            if (accuracy >= 90) {
                message = 'ğŸŒŸ å¤ªæ£’äº†ï¼æ‚¨å·²ç»æŒæ¡å¾—éå¸¸å¥½äº†ï¼';
            } else if (accuracy >= 75) {
                message = 'ğŸ‘ ä¸é”™ï¼ç»§ç»­ä¿æŒï¼Œæ‚¨åšå¾—å¾ˆå¥½ï¼';
            } else if (accuracy >= 60) {
                message = 'ğŸ’ª åŠ æ²¹ï¼å¤šç»ƒå‡ è½®å°±èƒ½å®Œå…¨æŒæ¡äº†ï¼';
            } else {
                message = 'ğŸ“š ä¸è¦æ°”é¦ï¼Œç†Ÿèƒ½ç”Ÿå·§ï¼è®©æˆ‘ä»¬å†ç»ƒä¸€è½®å§ï¼';
            }
            
            if (unfamiliarCount > 0) {
                message += `\né‡ç‚¹å¤ä¹ æ ‡è®°ä¸ºä¸ç†Ÿæ‚‰çš„ ${unfamiliarCount} ä¸ªå•è¯ã€‚`;
            }
            
            completionMessage.textContent = message;
            
            // ç”Ÿæˆè¿›åº¦å›¾
            if (completionProgress) {
                completionProgress.innerHTML = '';
                
                // åˆ›å»ºæ–¹å—ç½‘æ ¼
                const gridDiv = document.createElement('div');
                gridDiv.className = 'history-grid';
                
                // æ˜¾ç¤ºæ‰€æœ‰é¢˜ç›®çš„æ–¹å—
                for (let i = 0; i < totalQuestions; i++) {
                    const box = document.createElement('div');
                    box.className = 'history-box';
                    
                    const answerItem = roundData[i];
                    
                    if (answerItem) {
                        // ç¡®å®šé¢œè‰²åˆ†ç±»
                        if (answerItem.unfamiliar) {
                            box.classList.add('unfamiliar');
                        } else if (roundData.length > 3 && answerItem.time > threshold) {
                            box.classList.add('slow');
                        } else {
                            box.classList.add('known');
                        }
                        
                        // åˆ›å»ºæ‚¬åœæç¤ºï¼ˆæ·»åŠ åˆ°bodyè€Œä¸æ˜¯boxï¼Œé¿å…è§¦å‘æ»šåŠ¨æ¡ï¼‰
                        const tooltip = document.createElement('div');
                        tooltip.className = 'history-tooltip';
                        tooltip.innerHTML = `
                            <div class="tooltip-time">â±ï¸ ${answerItem.time}s</div>
                            <div class="tooltip-question">ğŸ“ ${answerItem.question}</div>
                            <div class="tooltip-answer">âœ“ ${answerItem.answer}</div>
                        `;
                        document.body.appendChild(tooltip);
                        
                        // é¼ æ ‡ç§»åŠ¨æ—¶åŠ¨æ€å®šä½tooltipå¹¶æ˜¾ç¤º
                        box.addEventListener('mouseenter', function(e) {
                            const rect = box.getBoundingClientRect();
                            
                            // å…ˆæ˜¾ç¤ºtooltipä»¥ä¾¿è·å–å…¶å°ºå¯¸
                            tooltip.style.display = 'block';
                            tooltip.style.opacity = '0';
                            const tooltipRect = tooltip.getBoundingClientRect();
                            
                            const spaceAbove = rect.top;
                            const spaceBelow = window.innerHeight - rect.bottom;
                            
                            if (spaceAbove > tooltipRect.height + 10 && spaceBelow < tooltipRect.height + 10) {
                                tooltip.style.top = (rect.top + window.scrollY - tooltipRect.height - 8) + 'px';
                            } else {
                                tooltip.style.top = (rect.bottom + window.scrollY + 8) + 'px';
                            }
                            
                            let left = rect.left + window.scrollX + rect.width / 2 - tooltipRect.width / 2;
                            if (left < 10) left = 10;
                            if (left + tooltipRect.width > window.innerWidth - 10) {
                                left = window.innerWidth - tooltipRect.width - 10;
                            }
                            tooltip.style.left = left + 'px';
                            
                            // æ˜¾ç¤ºtooltip
                            tooltip.style.opacity = '1';
                        });
                        
                        // é¼ æ ‡ç¦»å¼€æ—¶éšè—tooltip
                        box.addEventListener('mouseleave', function(e) {
                            tooltip.style.opacity = '0';
                            setTimeout(() => {
                                tooltip.style.display = 'none';
                            }, 200);
                        });
                    } else {
                        // æœªå®Œæˆçš„é¢˜ç›®ï¼ˆæ— tooltipï¼‰
                        box.classList.add('empty');
                    }
                    
                    gridDiv.appendChild(box);
                }
                
                completionProgress.appendChild(gridDiv);
            }
            
            // æ˜¾ç¤ºå¼¹çª—
            completionModal.classList.add('show');
        }
        
        // å¼€å§‹æ–°ä¸€è½®
        function startNewRound() {
            // éšè—å¼¹çª—
            if (completionModal) {
                completionModal.classList.remove('show');
            }
            
            // æ¸…ç©ºå¿«ç…§
            completedRoundSnapshot = null;
            
            // é‡ç½®ç»ƒä¹ 
            resetExercise();
        }
        
        // æ›´æ–°å•è¯çš„ä¸ç†Ÿæ‚‰çŠ¶æ€
        function updateUnfamiliarStatus() {
            const currentItem = shuffledData[currentQuestionIndex];
            let historyWord;
            if (currentMode === 'de-to-cn') {
                historyWord = currentItem.noun;
            } else if (currentMode === 'de-to-plural') {
                historyWord = `${currentItem.article} ${currentItem.noun}`;
            } else {
                historyWord = currentItem.meaning;
            }
            
            // æŸ¥æ‰¾å¹¶æ›´æ–°å†å²è®°å½•
            const existingWord = historyWords.find(item => item.word === historyWord);
            if (existingWord && !existingWord.unfamiliar) {
                existingWord.unfamiliar = true;
                updateHistoryDisplay(); // æ›´æ–°æ˜¾ç¤º
            }
        }

        // å¯ç”¨ä¸‹ä¸€é¢˜æŒ‰é’®å¹¶ç¦ç”¨ç†Ÿæ‚‰/ä¸ç†Ÿæ‚‰æŒ‰é’®
        function enableNextButton() {
            if (nextBtn) {
                nextBtn.disabled = false;
            }
            if (knowBtn) {
                knowBtn.disabled = true;
            }
            if (unfamiliarBtn) {
                unfamiliarBtn.disabled = true;
            }
        }

        // é‡ç½®å¡ç‰‡
        function resetCard() {
            if (questionText) {
                questionText.textContent = 'ç‚¹å‡»å¡ç‰‡å¼€å§‹å­¦ä¹ ';
            }
            if (dwdsLink) {
                dwdsLink.style.display = 'none';
            }
            if (answerArea) {
                answerArea.style.display = 'none';
            }
            if (answerContent) {
                answerContent.textContent = '';
            }
            if (ratingButtons) {
                ratingButtons.style.display = 'flex';
            }
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            if (nextBtn) {
                nextBtn.disabled = true; // ç¦ç”¨ä¸‹ä¸€é¢˜æŒ‰é’®
            }
            if (knowBtn) {
                knowBtn.disabled = false; // å¯ç”¨ç†Ÿæ‚‰æŒ‰é’®
            }
            if (unfamiliarBtn) {
                unfamiliarBtn.disabled = false; // å¯ç”¨ä¸ç†Ÿæ‚‰æŒ‰é’®
            }
            if (studyCard) {
                studyCard.classList.remove('has-question');
            }
            resetTimer();
        }

        // å¼€å§‹è®¡æ—¶
        function startTimer() {
            if (timerInterval) return;
            
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
        }

        // åœæ­¢è®¡æ—¶
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // é‡ç½®è®¡æ—¶å™¨
        function resetTimer() {
            stopTimer();
            startTime = 0; // æ˜¾å¼é‡ç½®å¼€å§‹æ—¶é—´
            if (timerDisplay) {
                timerDisplay.textContent = 'æ—¶é—´: 00:00';
            }
        }

        // æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤º
        function updateTimer() {
            if (!timerDisplay) return;
            
            const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsedSeconds / 60).toString().padStart(2, '0');
            const seconds = (elapsedSeconds % 60).toString().padStart(2, '0');
            timerDisplay.textContent = `æ—¶é—´: ${minutes}:${seconds}`;
        }

        // æ›´æ–°è®¡æ•°å™¨
        function updateCounter() {
            if (!counterDisplay) return;
            counterDisplay.textContent = `å·²å®Œæˆ: ${completedQuestions}/${totalQuestions}`;
        }
        
        // æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
        function updateHistoryDisplay() {
            if (!historyWordsContainer) return;
            
            // æ¸…ç†æ—§çš„tooltipå…ƒç´ 
            const oldTooltips = document.querySelectorAll('.history-tooltip');
            oldTooltips.forEach(tooltip => tooltip.remove());
            
            historyWordsContainer.innerHTML = '';
            
            // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
            const stats = calculateStats();
            const threshold = stats.mean + Math.sqrt(stats.variance);
            const unfamiliarCount = historyWords.filter(item => item.unfamiliar).length;
            const slowCount = historyWords.filter(item => !item.unfamiliar && item.time > threshold).length;
            const knownCount = historyWords.length - unfamiliarCount - slowCount;
            const emptyCount = totalQuestions - historyWords.length;
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            const historyStats = document.getElementById('history-stats');
            if (historyStats) {
                historyStats.innerHTML = `
                    <span class="stat-badge" style="background: #E8F5E9; border-color: #4CAF50; color: #2E7D32;">
                        <i class="fas fa-check-circle"></i> è®¤è¯†: ${knownCount}
                    </span>
                    ${slowCount > 0 ? `
                    <span class="stat-badge" style="background: #FFF3E0; border-color: #FF9800; color: #E65100;">
                        <i class="fas fa-clock"></i> æ…¢é€Ÿ: ${slowCount}
                    </span>
                    ` : ''}
                    ${unfamiliarCount > 0 ? `
                    <span class="stat-badge" style="background: #FFEBEE; border-color: #D32F2F; color: #B71C1C;">
                        <i class="fas fa-times-circle"></i> ä¸ç†Ÿæ‚‰: ${unfamiliarCount}
                    </span>
                    ` : ''}
                    ${emptyCount > 0 ? `
                    <span class="stat-badge" style="background: var(--surface-elevated); border-color: var(--border); color: var(--text-muted);">
                        <i class="fas fa-hourglass-half"></i> å¾…å®Œæˆ: ${emptyCount}
                    </span>
                    ` : ''}
                `;
            }
            
            // åˆ›å»ºæ–¹å—ç½‘æ ¼
            const gridDiv = document.createElement('div');
            gridDiv.className = 'history-grid';
            
            // æ˜¾ç¤ºæ‰€æœ‰é¢˜ç›®çš„æ–¹å—ï¼ˆåŒ…æ‹¬æœªç­”çš„ï¼‰
            for (let i = 0; i < totalQuestions; i++) {
                const box = document.createElement('div');
                box.className = 'history-box';
                
                // æ£€æŸ¥è¯¥é¢˜æ˜¯å¦å·²å®Œæˆï¼ˆä½¿ç”¨currentRoundAnswersæŒ‰ç´¢å¼•è·å–ï¼‰
                const historyItem = currentRoundAnswers[i];
                
                if (historyItem) {
                    // å·²å®Œæˆçš„é¢˜ç›® - ç›´æ¥ä½¿ç”¨historyItemä¸­çš„æ•°æ®
                    const questionText = historyItem.question;
                    const answerText = historyItem.answer;
                    
                    // ç¡®å®šé¢œè‰²åˆ†ç±»
                    if (historyItem.unfamiliar) {
                        box.classList.add('unfamiliar');
                    } else if (currentRoundAnswers.length > 3 && historyItem.time > threshold) {
                        box.classList.add('slow');
                    } else {
                        box.classList.add('known');
                    }
                    
                    // åˆ›å»ºæ‚¬åœæç¤ºï¼ˆæ·»åŠ åˆ°bodyè€Œä¸æ˜¯boxï¼Œé¿å…è§¦å‘æ»šåŠ¨æ¡ï¼‰
                    const tooltip = document.createElement('div');
                    tooltip.className = 'history-tooltip';
                    tooltip.innerHTML = `
                        <div class="tooltip-time">â±ï¸ ${historyItem.time}s</div>
                        <div class="tooltip-question">ğŸ“ ${questionText}</div>
                        <div class="tooltip-answer">âœ“ ${answerText}</div>
                    `;
                    document.body.appendChild(tooltip);
                    
                    // æ˜¾ç¤ºtooltipçš„å‡½æ•°
                    const showTooltipFunc = function() {
                        // å…ˆéšè—å…¶ä»–tooltip
                        document.querySelectorAll('.history-tooltip').forEach(t => {
                            if (t !== tooltip) {
                                t.style.opacity = '0';
                                t.style.display = 'none';
                            }
                        });
                        
                        const rect = box.getBoundingClientRect();
                        
                        // å…ˆæ˜¾ç¤ºtooltipä»¥ä¾¿è·å–å…¶å°ºå¯¸
                        tooltip.style.display = 'block';
                        tooltip.style.opacity = '0';
                        const tooltipRect = tooltip.getBoundingClientRect();
                        
                        // è®¡ç®—æ˜¯å¦æ˜¾ç¤ºåœ¨ä¸Šæ–¹æˆ–ä¸‹æ–¹
                        const spaceAbove = rect.top;
                        const spaceBelow = window.innerHeight - rect.bottom;
                        
                        if (spaceAbove > tooltipRect.height + 10 && spaceBelow < tooltipRect.height + 10) {
                            // æ˜¾ç¤ºåœ¨ä¸Šæ–¹
                            tooltip.style.top = (rect.top + window.scrollY - tooltipRect.height - 8) + 'px';
                        } else {
                            // æ˜¾ç¤ºåœ¨ä¸‹æ–¹
                            tooltip.style.top = (rect.bottom + window.scrollY + 8) + 'px';
                        }
                        
                        // æ°´å¹³å±…ä¸­ï¼Œä½†ç¡®ä¿ä¸è¶…å‡ºå±å¹•
                        let left = rect.left + window.scrollX + rect.width / 2 - tooltipRect.width / 2;
                        if (left < 10) left = 10;
                        if (left + tooltipRect.width > window.innerWidth - 10) {
                            left = window.innerWidth - tooltipRect.width - 10;
                        }
                        tooltip.style.left = left + 'px';
                        
                        // æ˜¾ç¤ºtooltip
                        tooltip.style.opacity = '1';
                    };
                    
                    const hideTooltipFunc = function() {
                        tooltip.style.opacity = '0';
                        setTimeout(() => {
                            tooltip.style.display = 'none';
                        }, 200);
                    };
                    
                    // æ¡Œé¢ç«¯ï¼šé¼ æ ‡æ‚¬åœæ˜¾ç¤ºtooltip
                    box.addEventListener('mouseenter', showTooltipFunc);
                    box.addEventListener('mouseleave', hideTooltipFunc);
                    
                    // ç‚¹å‡»äº‹ä»¶ï¼šè§¦æ‘¸è®¾å¤‡å’Œé¼ æ ‡è®¾å¤‡åˆ†åˆ«å¤„ç†
                    let tooltipVisibleState = false;
                    let lastClickTime = 0;
                    
                    box.addEventListener('click', function(e) {
                        e.stopPropagation();
                        
                        const currentTime = Date.now();
                        const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
                        
                        if (isTouchDevice) {
                            // ç§»åŠ¨ç«¯ï¼šç¬¬ä¸€æ¬¡ç‚¹å‡»æ˜¾ç¤ºtooltipï¼Œç¬¬äºŒæ¬¡ç‚¹å‡»æœ—è¯»
                            if (!tooltipVisibleState || (currentTime - lastClickTime > 3000)) {
                                // æ˜¾ç¤ºtooltip
                                showTooltipFunc();
                                tooltipVisibleState = true;
                                lastClickTime = currentTime;
                            } else {
                                // æœ—è¯»å¹¶éšè—
                                speakText(historyItem.question, 'de-DE');
                                hideTooltipFunc();
                                tooltipVisibleState = false;
                            }
                        } else {
                            // æ¡Œé¢ç«¯ï¼šç›´æ¥æœ—è¯»
                            speakText(historyItem.question, 'de-DE');
                        }
                    });
                    
                    // è§¦æ‘¸å¼€å§‹äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
                    box.addEventListener('touchstart', function(e) {
                        e.stopPropagation();
                    });
                } else {
                    // æœªå®Œæˆçš„é¢˜ç›® - æ˜¾ç¤ºç©ºç™½æ–¹å—ï¼ˆæ— tooltipï¼‰
                    box.classList.add('empty');
                }
                
                gridDiv.appendChild(box);
            }
            
            historyWordsContainer.appendChild(gridDiv);
        }
        
        // æ·»åŠ åˆ°å†å²è®°å½•
        // è®¡ç®—å‡å€¼å’Œæ–¹å·®
        function calculateStats() {
            // ä½¿ç”¨å½“å‰è½®æ¬¡çš„ç­”é¢˜è®°å½•è®¡ç®—ç»Ÿè®¡æ•°æ®
            if (currentRoundAnswers.length < 2) return { mean: 0, variance: 0 };
            const times = currentRoundAnswers.map(item => item.time);
            const mean = times.reduce((sum, time) => sum + time, 0) / times.length;
            const variance = times.reduce((sum, time) => sum + Math.pow(time - mean, 2), 0) / times.length;
            return { mean, variance };
        }

        // æ·»åŠ åˆ°å†å²è®°å½•
        function addToHistory(word, unfamiliar = false, time = 0) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥å•è¯
            const existingIndex = historyWords.findIndex(item => item.word === word);
            
            if (existingIndex !== -1) {
                // å¦‚æœå·²å­˜åœ¨ï¼Œæ›´æ–°è®°å½•
                historyWords[existingIndex].unfamiliar = unfamiliar;
                historyWords[existingIndex].time = time;
            } else {
                // å¦‚æœä¸å­˜åœ¨ï¼Œæ·»åŠ æ–°è®°å½•
                historyWords.unshift({word, unfamiliar, time});
                // é™åˆ¶å†å²è®°å½•æ•°é‡
                if (historyWords.length > MAX_HISTORY) {
                    historyWords.pop();
                }
                }
                updateHistoryDisplay();
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);
        
        // å…¨å±€ç‚¹å‡»äº‹ä»¶ï¼šç‚¹å‡»ç©ºç™½å¤„éšè—æ‰€æœ‰tooltipï¼ˆç§»åŠ¨ç«¯å‹å¥½ï¼‰
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.history-box')) {
                document.querySelectorAll('.history-tooltip').forEach(tooltip => {
                    tooltip.style.opacity = '0';
                    setTimeout(() => tooltip.style.display = 'none', 200);
                });
            }
        });
    </script>
</body>
</html>