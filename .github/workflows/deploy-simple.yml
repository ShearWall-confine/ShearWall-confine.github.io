name: Deploy to GitHub Pages (Simple)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Generate GitHub Secrets Config
      env:
        ADMIN_PASSWORD_HASH: ${{ secrets.ADMIN_PASSWORD_HASH }}
        EDITOR_PASSWORD_HASH: ${{ secrets.EDITOR_PASSWORD_HASH }}
        VIEWER_PASSWORD_HASH: ${{ secrets.VIEWER_PASSWORD_HASH }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
      run: |
        echo "ðŸ” ç”ŸæˆGitHub Secretsé…ç½®æ–‡ä»¶..."
        
        # ç”Ÿæˆ github-secrets-config.js
        cat > github-secrets-config.js << 'EOF'
        /**
         * GitHub Secrets é…ç½®æ–‡ä»¶
         * æ­¤æ–‡ä»¶åœ¨GitHub Actionsæž„å»ºæ—¶ä¼šè¢«åŠ¨æ€ç”Ÿæˆ
         * åŒ…å«ä»ŽGitHub SecretsèŽ·å–çš„å¯†ç å“ˆå¸Œå€¼
         * ç”Ÿæˆæ—¶é—´: $(date)
         */
        
        // è¿™äº›å€¼ä»ŽGitHub Secretsä¸­æ³¨å…¥
        window.GITHUB_SECRETS = {
          ADMIN_PASSWORD_HASH: '${{ secrets.ADMIN_PASSWORD_HASH }}',
          EDITOR_PASSWORD_HASH: '${{ secrets.EDITOR_PASSWORD_HASH }}',
          VIEWER_PASSWORD_HASH: '${{ secrets.VIEWER_PASSWORD_HASH }}',
          JWT_SECRET: '${{ secrets.JWT_SECRET }}',
          ENCRYPTION_KEY: '${{ secrets.ENCRYPTION_KEY }}'
        };
        
        // å¼€å‘çŽ¯å¢ƒå›žé€€å€¼ï¼ˆå½“GitHub Secretsæœªè®¾ç½®æ—¶ä½¿ç”¨ï¼‰
        if (!window.GITHUB_SECRETS.ADMIN_PASSWORD_HASH || 
            window.GITHUB_SECRETS.ADMIN_PASSWORD_HASH.includes('secrets.')) {
          console.warn('âš ï¸ ä½¿ç”¨å¼€å‘çŽ¯å¢ƒé…ç½®ï¼Œè¯·è®¾ç½®GitHub Secrets');
          window.GITHUB_SECRETS = {
            ADMIN_PASSWORD_HASH: 'dev_admin_hash',
            EDITOR_PASSWORD_HASH: 'dev_editor_hash', 
            VIEWER_PASSWORD_HASH: 'dev_viewer_hash',
            JWT_SECRET: 'dev_jwt_secret',
            ENCRYPTION_KEY: 'dev_encryption_key'
          };
        }
        
        // å¯¼å‡ºåˆ°å…¨å±€
        if (typeof module !== 'undefined' && module.exports) {
          module.exports = window.GITHUB_SECRETS;
        }
        EOF
        
        # ç”Ÿæˆ user-config.js
        cat > user-config.js << 'EOF'
        /**
         * ç”¨æˆ·é…ç½®æ–‡ä»¶
         * åŒ…å«å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯å’Œæƒé™é…ç½®
         * ç”Ÿæˆæ—¶é—´: $(date)
         */
        
        const USER_CONFIG = {
          defaultUsers: {
            'admin': {
              username: 'admin',
              role: 'admin',
              name: 'ç³»ç»Ÿç®¡ç†å‘˜',
              email: 'admin@example.com',
              passwordHash: '${{ secrets.ADMIN_PASSWORD_HASH }}'
            },
            'editor': {
              username: 'editor', 
              role: 'editor',
              name: 'ç¼–è¾‘è€…',
              email: 'editor@example.com',
              passwordHash: '${{ secrets.EDITOR_PASSWORD_HASH }}'
            },
            'viewer': {
              username: 'viewer',
              role: 'viewer', 
              name: 'æŸ¥çœ‹è€…',
              email: 'viewer@example.com',
              passwordHash: '${{ secrets.VIEWER_PASSWORD_HASH }}'
            }
          }
        };
        
        // å¯†ç éªŒè¯å‡½æ•°
        function verifyPassword(inputPassword, storedHash) {
          // è¿™é‡Œåº”è¯¥ä½¿ç”¨ä¸Žgenerate-secrets.pyç›¸åŒçš„å“ˆå¸Œç®—æ³•
          // ç›®å‰ä»…ç”¨äºŽå¼€å‘çŽ¯å¢ƒï¼Œç”Ÿäº§çŽ¯å¢ƒåº”ä½¿ç”¨æœåŠ¡å™¨ç«¯éªŒè¯
          return true; // ä¸´æ—¶è¿”å›žtrueï¼Œå®žé™…åº”éªŒè¯å“ˆå¸Œ
        }
        
        // å¯¼å‡ºå‡½æ•°
        if (typeof module !== 'undefined' && module.exports) {
          module.exports = {
            USER_CONFIG,
            verifyPassword
          };
        } else {
          // æµè§ˆå™¨çŽ¯å¢ƒ
          window.USER_CONFIG = USER_CONFIG;
          window.verifyPassword = verifyPassword;
        }
        EOF
        
        echo "âœ… é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
        
    - name: Verify Secrets Injection
      run: |
        echo "ðŸ” éªŒè¯GitHub Secretsæ³¨å…¥..."
        
        # æ£€æŸ¥ github-secrets-config.js
        if grep -q "ADMIN_PASSWORD_HASH.*secrets" github-secrets-config.js; then
          echo "âœ… GitHub Secretsé…ç½®å·²æ­£ç¡®æ³¨å…¥"
        else
          echo "âŒ GitHub Secretsé…ç½®æ³¨å…¥å¤±è´¥"
          exit 1
        fi
        
        # æ£€æŸ¥ user-config.js
        if grep -q "ADMIN_PASSWORD_HASH" user-config.js; then
          echo "âœ… ç”¨æˆ·é…ç½®æ–‡ä»¶å·²æ­£ç¡®ç”Ÿæˆ"
        else
          echo "âŒ ç”¨æˆ·é…ç½®æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
          exit 1
        fi
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        
    - name: Verify Deployment
      run: |
        echo "ðŸš€ éƒ¨ç½²éªŒè¯å®Œæˆ"
        echo "GitHub Pages URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
