name: Deploy to GitHub Pages with Secrets

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨æ›´æ–°é…ç½®ï¼ˆå¯é€‰ï¼‰
    - cron: '0 2 * * *'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
      actions: read
      checks: write
      pull-requests: write
      statuses: write
      security-events: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        echo "ðŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–..."
        npm install --package-lock-only
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
        
    - name: Generate GitHub Secrets Config
      env:
        ADMIN_PASSWORD_HASH: ${{ secrets.ADMIN_PASSWORD_HASH }}
        EDITOR_PASSWORD_HASH: ${{ secrets.EDITOR_PASSWORD_HASH }}
        VIEWER_PASSWORD_HASH: ${{ secrets.VIEWER_PASSWORD_HASH }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
      run: |
        echo "ðŸ” ç”ŸæˆGitHub Secretsé…ç½®æ–‡ä»¶..."
        
        # ç”Ÿæˆ github-secrets-config.js
        cat > github-secrets-config.js << 'EOF'
        /**
         * GitHub Secrets é…ç½®æ–‡ä»¶
         * æ­¤æ–‡ä»¶åœ¨GitHub Actionsæž„å»ºæ—¶ä¼šè¢«åŠ¨æ€ç”Ÿæˆ
         * åŒ…å«ä»ŽGitHub SecretsèŽ·å–çš„å¯†ç å“ˆå¸Œå€¼
         * ç”Ÿæˆæ—¶é—´: $(date)
         */
        
        // è¿™äº›å€¼ä»ŽGitHub Secretsä¸­æ³¨å…¥
        window.GITHUB_SECRETS = {
          ADMIN_PASSWORD_HASH: '${{ secrets.ADMIN_PASSWORD_HASH }}',
          EDITOR_PASSWORD_HASH: '${{ secrets.EDITOR_PASSWORD_HASH }}',
          VIEWER_PASSWORD_HASH: '${{ secrets.VIEWER_PASSWORD_HASH }}',
          JWT_SECRET: '${{ secrets.JWT_SECRET }}',
          ENCRYPTION_KEY: '${{ secrets.ENCRYPTION_KEY }}'
        };
        
        // ç”Ÿäº§çŽ¯å¢ƒæ£€æŸ¥ï¼ˆä¸å…è®¸å¼€å‘çŽ¯å¢ƒå›žé€€ï¼‰
        if (!window.GITHUB_SECRETS.ADMIN_PASSWORD_HASH || 
            window.GITHUB_SECRETS.ADMIN_PASSWORD_HASH.includes('secrets.')) {
          console.error('âŒ GitHub Secretsæœªæ­£ç¡®é…ç½®ï¼Œéƒ¨ç½²å¤±è´¥');
          throw new Error('GitHub Secretsæœªé…ç½®ï¼Œè¯·è®¾ç½®ç”Ÿäº§çŽ¯å¢ƒå¯†é’¥');
        }
        
        // å¯¼å‡ºåˆ°å…¨å±€
        if (typeof module !== 'undefined' && module.exports) {
          module.exports = window.GITHUB_SECRETS;
        }
        EOF
        
        # ç”Ÿæˆ user-config.js
        cat > user-config.js << 'EOF'
        /**
         * ç”¨æˆ·é…ç½®æ–‡ä»¶
         * åŒ…å«å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯å’Œæƒé™é…ç½®
         * ç”Ÿæˆæ—¶é—´: $(date)
         */
        
        const USER_CONFIG = {
          defaultUsers: {
            'admin': {
              username: 'admin',
              role: 'admin',
              name: 'ç³»ç»Ÿç®¡ç†å‘˜',
              email: 'admin@example.com',
              passwordHash: '${{ secrets.ADMIN_PASSWORD_HASH }}'
            },
            'editor': {
              username: 'editor', 
              role: 'editor',
              name: 'ç¼–è¾‘è€…',
              email: 'editor@example.com',
              passwordHash: '${{ secrets.EDITOR_PASSWORD_HASH }}'
            },
            'viewer': {
              username: 'viewer',
              role: 'viewer', 
              name: 'æŸ¥çœ‹è€…',
              email: 'viewer@example.com',
              passwordHash: '${{ secrets.VIEWER_PASSWORD_HASH }}'
            }
          }
        };
        
        // å¯†ç éªŒè¯å‡½æ•°
        function verifyPassword(inputPassword, storedHash) {
          // ç”Ÿäº§çŽ¯å¢ƒï¼šä½¿ç”¨ä¸Žgenerate-secrets.pyç›¸åŒçš„å“ˆå¸Œç®—æ³•
          if (typeof window !== 'undefined' && window.simpleHash) {
            return window.simpleHash(inputPassword) === storedHash;
          }
          
          // å¦‚æžœsimpleHashä¸å¯ç”¨ï¼Œä½¿ç”¨åŸºç¡€éªŒè¯
          console.warn('âš ï¸ ä½¿ç”¨åŸºç¡€å¯†ç éªŒè¯ï¼Œå»ºè®®é…ç½®å®Œæ•´çš„å“ˆå¸Œç®—æ³•');
          return false; // ç”Ÿäº§çŽ¯å¢ƒä¸å…è®¸ç®€å•éªŒè¯
        }
        
        // å¯¼å‡ºå‡½æ•°
        if (typeof module !== 'undefined' && module.exports) {
          module.exports = {
            USER_CONFIG,
            verifyPassword
          };
        } else {
          // æµè§ˆå™¨çŽ¯å¢ƒ
          window.USER_CONFIG = USER_CONFIG;
          window.verifyPassword = verifyPassword;
        }
        EOF
        
        echo "âœ… é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
        
    - name: Verify Files Generated
      run: |
        echo "ðŸ” æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶..."
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -f "github-secrets-config.js" ] && [ -f "user-config.js" ]; then
          echo "âœ… é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ"
          echo "æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -la *.js
        else
          echo "âŒ é…ç½®æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
          exit 1
        fi
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
        
    - name: Verify Deployment
      run: |
        echo "ðŸš€ éƒ¨ç½²éªŒè¯å®Œæˆ"
        echo "GitHub Pages URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        echo "ðŸ”§ å½“å‰ä½¿ç”¨å¼€å‘çŽ¯å¢ƒé…ç½®"
        echo "ðŸ“ è¦ä½¿ç”¨ç”Ÿäº§çŽ¯å¢ƒï¼Œè¯·è®¾ç½®GitHub Secrets"
