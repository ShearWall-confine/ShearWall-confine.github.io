name: Deploy to GitHub Pages with Secrets

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨æ›´æ–°é…ç½®ï¼ˆå¯é€‰ï¼‰
    - cron: '0 2 * * *'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Generate GitHub Secrets Config
      env:
        ADMIN_PASSWORD_HASH: ${{ secrets.ADMIN_PASSWORD_HASH }}
        EDITOR_PASSWORD_HASH: ${{ secrets.EDITOR_PASSWORD_HASH }}
        VIEWER_PASSWORD_HASH: ${{ secrets.VIEWER_PASSWORD_HASH }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
      run: |
        echo "ðŸ” ç”ŸæˆGitHub Secretsé…ç½®æ–‡ä»¶..."
        
        # ç”Ÿæˆ github-secrets-config.js
        cat > github-secrets-config.js << 'EOF'
        /**
         * GitHub Secrets é…ç½®æ–‡ä»¶
         * æ­¤æ–‡ä»¶åœ¨GitHub Actionsæž„å»ºæ—¶ä¼šè¢«åŠ¨æ€ç”Ÿæˆ
         * åŒ…å«ä»ŽGitHub SecretsèŽ·å–çš„å¯†ç å“ˆå¸Œå€¼
         * ç”Ÿæˆæ—¶é—´: $(date)
         */
        
        // è¿™äº›å€¼ä»ŽGitHub Secretsä¸­æ³¨å…¥
        window.GITHUB_SECRETS = {
          ADMIN_PASSWORD_HASH: '${{ secrets.ADMIN_PASSWORD_HASH }}',
          EDITOR_PASSWORD_HASH: '${{ secrets.EDITOR_PASSWORD_HASH }}',
          VIEWER_PASSWORD_HASH: '${{ secrets.VIEWER_PASSWORD_HASH }}',
          JWT_SECRET: '${{ secrets.JWT_SECRET }}',
          ENCRYPTION_KEY: '${{ secrets.ENCRYPTION_KEY }}'
        };
        
        // å¼€å‘çŽ¯å¢ƒå›žé€€å€¼
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          window.GITHUB_SECRETS = {
            ADMIN_PASSWORD_HASH: 'dev_hash_admin_2024',
            EDITOR_PASSWORD_HASH: 'dev_hash_editor_2024',
            VIEWER_PASSWORD_HASH: 'dev_hash_viewer_2024',
            JWT_SECRET: 'dev_jwt_secret',
            ENCRYPTION_KEY: 'dev_encryption_key'
          };
        }
        EOF
        
        # ç”Ÿæˆ user-config.jsï¼ˆç”¨äºŽæœåŠ¡å™¨ç«¯éªŒè¯ï¼‰
        cat > user-config.js << 'EOF'
        /**
         * ç”¨æˆ·é…ç½®æ–‡ä»¶ - ç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ
         * åŒ…å«ä»ŽGitHub SecretsèŽ·å–çš„å®‰å…¨é…ç½®
         * ç”Ÿæˆæ—¶é—´: $(date)
         */
        
        // ä»ŽçŽ¯å¢ƒå˜é‡èŽ·å–çš„é…ç½®
        const USER_CONFIG = {
            // ç”¨æˆ·æ•°æ®åº“ï¼ˆä»ŽGitHub SecretsèŽ·å–ï¼‰
            defaultUsers: {
                'admin': {
                    passwordHash: process.env.ADMIN_PASSWORD_HASH || 'dev_hash_admin_2024',
                    role: 'admin',
                    name: 'ç³»ç»Ÿç®¡ç†å‘˜',
                    email: 'admin@system.local',
                    created: '2024-01-01',
                    lastLogin: null,
                    isActive: true
                },
                'editor': {
                    passwordHash: process.env.EDITOR_PASSWORD_HASH || 'dev_hash_editor_2024',
                    role: 'editor',
                    name: 'ç¼–è¾‘ç”¨æˆ·',
                    email: 'editor@system.local',
                    created: '2024-01-01',
                    lastLogin: null,
                    isActive: true
                },
                'viewer': {
                    passwordHash: process.env.VIEWER_PASSWORD_HASH || 'dev_hash_viewer_2024',
                    role: 'viewer',
                    name: 'æŸ¥çœ‹ç”¨æˆ·',
                    email: 'viewer@system.local',
                    created: '2024-01-01',
                    lastLogin: null,
                    isActive: true
                }
            },
            
            // å®‰å…¨é…ç½®
            security: {
                jwtSecret: process.env.JWT_SECRET || 'dev_jwt_secret',
                encryptionKey: process.env.ENCRYPTION_KEY || 'dev_encryption_key',
                sessionTimeout: 24 * 60 * 60 * 1000, // 24å°æ—¶
                maxLoginAttempts: 5,
                lockoutDuration: 15 * 60 * 1000 // 15åˆ†é’Ÿ
            },
            
            // è§’è‰²æƒé™é…ç½®
            roles: {
                'admin': {
                    canView: true,
                    canEdit: true,
                    canDelete: true,
                    canExport: true,
                    canImport: true,
                    canManageUsers: true
                },
                'editor': {
                    canView: true,
                    canEdit: true,
                    canDelete: false,
                    canExport: true,
                    canImport: true,
                    canManageUsers: false
                },
                'viewer': {
                    canView: true,
                    canEdit: false,
                    canDelete: false,
                    canExport: false,
                    canImport: false,
                    canManageUsers: false
                }
            }
        };
        
        // å¯†ç éªŒè¯å‡½æ•°ï¼ˆä½¿ç”¨çŽ¯å¢ƒå˜é‡ä¸­çš„å“ˆå¸Œï¼‰
        function verifyPassword(password, storedHash) {
            try {
                // è§£æžå­˜å‚¨çš„å“ˆå¸Œï¼ˆæ ¼å¼ï¼šsalt:hashï¼‰
                const [salt, hash] = storedHash.split(':');
                if (!salt || !hash) {
                    console.error('æ— æ•ˆçš„å“ˆå¸Œæ ¼å¼');
                    return false;
                }
                
                // é‡æ–°è®¡ç®—å“ˆå¸Œè¿›è¡Œæ¯”è¾ƒ
                const crypto = require('crypto');
                const computedHash = crypto.pbkdf2Sync(password, salt, 10000, 64, 'sha512').toString('hex');
                
                return computedHash === hash;
            } catch (error) {
                console.error('å¯†ç éªŒè¯å¤±è´¥:', error.message);
                return false;
            }
        }
        
        // å¯¼å‡ºé…ç½®
        if (typeof module !== 'undefined' && module.exports) {
            module.exports = {
                USER_CONFIG,
                verifyPassword
            };
        }
        
        // æµè§ˆå™¨çŽ¯å¢ƒ
        if (typeof window !== 'undefined') {
            window.USER_CONFIG = USER_CONFIG;
            window.verifyPassword = verifyPassword;
        }
        EOF
        
        echo "âœ… é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
        
    - name: Verify Secrets Injection
      run: |
        echo "ðŸ” éªŒè¯GitHub Secretsæ³¨å…¥..."
        
        # æ£€æŸ¥ github-secrets-config.js
        if grep -q "ADMIN_PASSWORD_HASH.*secrets" github-secrets-config.js; then
          echo "âœ… GitHub Secretsé…ç½®å·²æ­£ç¡®æ³¨å…¥"
        else
          echo "âŒ GitHub Secretsé…ç½®æ³¨å…¥å¤±è´¥"
          exit 1
        fi
        
        # æ£€æŸ¥ user-config.js
        if grep -q "ADMIN_PASSWORD_HASH" user-config.js; then
          echo "âœ… ç”¨æˆ·é…ç½®æ–‡ä»¶å·²æ­£ç¡®ç”Ÿæˆ"
        else
          echo "âŒ ç”¨æˆ·é…ç½®æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
          exit 1
        fi
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        
    - name: Verify Deployment
      run: |
        echo "ðŸš€ éƒ¨ç½²éªŒè¯å®Œæˆ"
        echo "GitHub Pages URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
