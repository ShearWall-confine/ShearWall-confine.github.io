name: Deploy to GitHub Pages with Secrets

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨æ›´æ–°é…ç½®ï¼ˆå¯é€‰ï¼‰
    - cron: '0 2 * * *'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
      actions: read
      checks: write
      pull-requests: write
      statuses: write
      security-events: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        echo "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–..."
        npm install --package-lock-only
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
        
    - name: Generate GitHub Secrets Config
      env:
        ADMIN_PASSWORD_HASH: ${{ secrets.ADMIN_PASSWORD_HASH }}
        EDITOR_PASSWORD_HASH: ${{ secrets.EDITOR_PASSWORD_HASH }}
        VIEWER_PASSWORD_HASH: ${{ secrets.VIEWER_PASSWORD_HASH }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
      run: |
        echo "ğŸ” ç”ŸæˆGitHub Secretsé…ç½®æ–‡ä»¶..."
        
        # ç”Ÿæˆ github-secrets-config.js
        cat > github-secrets-config.js << 'EOF'
        /**
         * GitHub Secrets é…ç½®æ–‡ä»¶
         * æ­¤æ–‡ä»¶åœ¨GitHub Actionsæ„å»ºæ—¶ä¼šè¢«åŠ¨æ€ç”Ÿæˆ
         * åŒ…å«ä»GitHub Secretsè·å–çš„å¯†ç å“ˆå¸Œå€¼
         * ç”Ÿæˆæ—¶é—´: $(date)
         */
        
        // è¿™äº›å€¼ä»GitHub Secretsä¸­æ³¨å…¥
        window.GITHUB_SECRETS = {
          ADMIN_PASSWORD_HASH: '${{ secrets.ADMIN_PASSWORD_HASH }}',
          EDITOR_PASSWORD_HASH: '${{ secrets.EDITOR_PASSWORD_HASH }}',
          VIEWER_PASSWORD_HASH: '${{ secrets.VIEWER_PASSWORD_HASH }}',
          JWT_SECRET: '${{ secrets.JWT_SECRET }}',
          ENCRYPTION_KEY: '${{ secrets.ENCRYPTION_KEY }}'
        };
        
        // ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥ï¼ˆä¸å…è®¸å¼€å‘ç¯å¢ƒå›é€€ï¼‰
        if (!window.GITHUB_SECRETS.ADMIN_PASSWORD_HASH || 
            window.GITHUB_SECRETS.ADMIN_PASSWORD_HASH.includes('secrets.')) {
          console.error('âŒ GitHub Secretsæœªæ­£ç¡®é…ç½®ï¼Œéƒ¨ç½²å¤±è´¥');
          throw new Error('GitHub Secretsæœªé…ç½®ï¼Œè¯·è®¾ç½®ç”Ÿäº§ç¯å¢ƒå¯†é’¥');
        }
        
        // å¯¼å‡ºåˆ°å…¨å±€
        if (typeof module !== 'undefined' && module.exports) {
          module.exports = window.GITHUB_SECRETS;
        }
        EOF
        
        # ç”Ÿæˆ user-config.js
        cat > user-config.js << 'EOF'
        /**
         * ç”¨æˆ·é…ç½®æ–‡ä»¶
         * åŒ…å«å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯å’Œæƒé™é…ç½®
         * ç”Ÿæˆæ—¶é—´: $(date)
         */
        
        const USER_CONFIG = {
          defaultUsers: {
            'admin': {
              username: 'admin',
              role: 'admin',
              name: 'ç³»ç»Ÿç®¡ç†å‘˜',
              email: 'admin@example.com',
              passwordHash: '${{ secrets.ADMIN_PASSWORD_HASH }}'
            },
            'editor': {
              username: 'editor', 
              role: 'editor',
              name: 'ç¼–è¾‘è€…',
              email: 'editor@example.com',
              passwordHash: '${{ secrets.EDITOR_PASSWORD_HASH }}'
            },
            'viewer': {
              username: 'viewer',
              role: 'viewer', 
              name: 'æŸ¥çœ‹è€…',
              email: 'viewer@example.com',
              passwordHash: '${{ secrets.VIEWER_PASSWORD_HASH }}'
            }
          }
        };
        
        // PBKDF2 å¯†ç éªŒè¯å‡½æ•°
        async function verifyPBKDF2(password, salt, hash) {
          try {
            // å°† salt ä» hex è½¬æ¢ä¸º Uint8Array
            const saltBytes = new Uint8Array(salt.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
            
            // å¯¼å…¥å¯†ç 
            const keyMaterial = await crypto.subtle.importKey(
              'raw',
              new TextEncoder().encode(password),
              { name: 'PBKDF2' },
              false,
              ['deriveBits']
            );
            
            // ä½¿ç”¨ PBKDF2 æ´¾ç”Ÿå¯†é’¥
            const derivedBits = await crypto.subtle.deriveBits(
              {
                name: 'PBKDF2',
                salt: saltBytes,
                iterations: 10000,
                hash: 'SHA-512'
              },
              keyMaterial,
              512 // 512 bits = 64 bytes
            );
            
            // å°†ç»“æœè½¬æ¢ä¸º hex å­—ç¬¦ä¸²
            const derivedHash = Array.from(new Uint8Array(derivedBits))
              .map(b => b.toString(16).padStart(2, '0'))
              .join('');
            
            return derivedHash === hash;
          } catch (error) {
            console.error('PBKDF2 éªŒè¯å¤±è´¥:', error);
            return false;
          }
        }
        
        // å¯†ç éªŒè¯å‡½æ•°
        async function verifyPassword(inputPassword, storedHash) {
          try {
            // æ£€æŸ¥æ˜¯å¦æ˜¯ PBKDF2 æ ¼å¼ï¼ˆsalt:hashï¼‰
            if (storedHash.includes(':')) {
              const [salt, hash] = storedHash.split(':');
              if (!salt || !hash) {
                console.error('æ— æ•ˆçš„å“ˆå¸Œæ ¼å¼');
                return false;
              }
              
              // ä½¿ç”¨ PBKDF2 ç®—æ³•éªŒè¯
              return await verifyPBKDF2(inputPassword, salt, hash);
            }
            
            // å›é€€åˆ° simpleHash éªŒè¯ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
            if (typeof window !== 'undefined' && window.simpleHash) {
              return window.simpleHash(inputPassword) === storedHash;
            }
            
            console.warn('âš ï¸ æ— æ³•éªŒè¯å¯†ç ï¼šæœªçŸ¥çš„å“ˆå¸Œæ ¼å¼');
            return false;
          } catch (error) {
            console.error('å¯†ç éªŒè¯å¤±è´¥:', error);
            return false;
          }
        }
        
        // å¯¼å‡ºå‡½æ•°
        if (typeof module !== 'undefined' && module.exports) {
          module.exports = {
            USER_CONFIG,
            verifyPassword
          };
        } else {
          // æµè§ˆå™¨ç¯å¢ƒ
          window.USER_CONFIG = USER_CONFIG;
          window.verifyPassword = verifyPassword;
        }
        EOF
        
        echo "âœ… é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
        
    - name: Verify Files Generated
      run: |
        echo "ğŸ” æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶..."
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -f "github-secrets-config.js" ] && [ -f "user-config.js" ]; then
          echo "âœ… é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ"
          echo "æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -la *.js
        else
          echo "âŒ é…ç½®æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
          exit 1
        fi
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
        
    - name: Verify Deployment
      run: |
        echo "ğŸš€ éƒ¨ç½²éªŒè¯å®Œæˆ"
        echo "GitHub Pages URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        echo "ğŸ”§ å½“å‰ä½¿ç”¨å¼€å‘ç¯å¢ƒé…ç½®"
        echo "ğŸ“ è¦ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒï¼Œè¯·è®¾ç½®GitHub Secrets"
